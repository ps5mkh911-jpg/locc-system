<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة عمليات الساحات الخارجية والمواصلات - LOCC</title>
    <style>
        /* ═══════════════ المتغيرات الأساسية ═══════════════ */
        :root {
            --primary: #ffd700;
            --bg-dark: #0a0a0a;
            --bg-card: #1a1a1a;
            --bg-input: #2a2a2a;
            --green: #4caf50;
            --blue: #2196f3;
            --red: #f44336;
            --orange: #ff9800;
            --purple: #9c27b0;
            --cyan: #00bcd4;
            --text: #fff;
            --text-muted: #888;
            --panel-width: 320px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow-x: hidden; }

        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            line-height: 1.6;
        }

        /* ═══════════════ شريط التمرير ═══════════════ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }

        /* ═══════════════ الرأسية ═══════════════ */
        .header {
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            padding: 10px 20px;
            border-bottom: 3px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 15px rgba(255,215,0,0.5);
        }

        .header-company {
            font-size: 1.8rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 10px var(--primary);
            border: 2px solid var(--primary);
            padding: 5px 20px;
            border-radius: 8px;
        }

        .header-info {
            display: flex;
            gap: 10px;
        }

        .info-box {
            background: rgba(255,215,0,0.1);
            border: 2px solid var(--primary);
            padding: 8px 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 100px;
        }

        .info-box-label { font-size: 0.7rem; color: var(--text-muted); }
        .info-box-value { font-size: 1.1rem; font-weight: 700; color: var(--primary); }

        /* ═══════════════ أشرطة الإحصائيات ═══════════════ */
        .stats-bar {
            background: var(--bg-card);
            padding: 5px 10px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 6px;
            border-bottom: 2px solid rgba(255,215,0,0.3);
        }

        .stats-bar-title {
            width: 100%;
            text-align: center;
            font-size: 0.7rem;
            color: var(--primary);
            margin-bottom: 3px;
            font-weight: 600;
        }

        .stat-card {
            background: rgba(255,215,0,0.05);
            border: 1px solid var(--primary);
            border-radius: 6px;
            padding: 4px 10px;
            text-align: center;
            min-width: 70px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,215,0,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255,215,0,0.3);
        }

        .stat-card.green { border-color: var(--green); }
        .stat-card.blue { border-color: var(--blue); }
        .stat-card.red { border-color: var(--red); animation: pulse-red 1s infinite; }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 5px var(--red); }
            50% { box-shadow: 0 0 25px var(--red), 0 0 50px var(--red); }
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            position: relative;
            z-index: 1;
        }

        .stat-card.green .stat-value { color: var(--green); }
        .stat-card.blue .stat-value { color: var(--blue); }
        .stat-card.red .stat-value { color: var(--red); }

        .stat-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            position: relative;
            z-index: 1;
        }

        /* ═══════════════ شريط التأشيرات ═══════════════ */
        .visa-bar {
            background: rgba(0,0,0,0.3);
            padding: 8px 15px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            border-bottom: 1px solid rgba(255,215,0,0.2);
        }

        .visa-card {
            background: var(--bg-input);
            border: 1px solid rgba(255,215,0,0.5);
            border-radius: 6px;
            padding: 6px 12px;
            text-align: center;
            min-width: 80px;
        }

        .visa-card-title { font-size: 0.7rem; color: var(--primary); }
        .visa-card-value { font-size: 1rem; font-weight: 700; color: #fff; }

        /* ═══════════════ شريط الإحصائيات الموحد ═══════════════ */
        .unified-stats-bar {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            padding: 5px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            border-bottom: 2px solid var(--primary);
        }

        .stats-group {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .stats-divider {
            width: 2px;
            height: 30px;
            background: var(--primary);
            margin: 0 8px;
            opacity: 0.5;
        }

        .mini-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mini-stat:hover {
            transform: scale(1.05);
        }

        .mini-stat:hover .mini-box {
            background: rgba(255,215,0,0.15);
        }

        .mini-stat.green .mini-box { border-color: var(--green); }
        .mini-stat.blue .mini-box { border-color: var(--blue); }
        .mini-stat.red .mini-box { border-color: var(--red); }

        .mini-box {
            background: rgba(255,215,0,0.05);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 4px;
            padding: 3px 8px;
            min-width: 35px;
            text-align: center;
        }

        .mini-value {
            display: block;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.2;
        }

        .mini-stat.green .mini-value { color: var(--green); }
        .mini-stat.blue .mini-value { color: var(--blue); }
        .mini-stat.red .mini-value { color: var(--red); }

        .mini-label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.2;
            margin-bottom: 2px;
        }

        /* ═══════════════ الحاوية الرئيسية ═══════════════ */
        .main-container {
            display: flex;
            min-height: calc(100vh - 180px);
        }

        .content-area {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        /* ═══════════════ حاوية المواقف الأفقية ═══════════════ */
        .parking-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* ═══════════════ منطقة المواقف ═══════════════ */
        .parking-section {
            flex: 1;
            margin-bottom: 0;
        }

        .section-title {
            text-align: center;
            font-size: 1.1rem;
            color: var(--primary);
            padding: 10px;
            background: rgba(255,215,0,0.1);
            border: 2px solid var(--primary);
            border-radius: 8px;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .parking-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .parking-grid.exit-grid {
            grid-template-columns: repeat(7, 1fr);
        }

        .parking-spot {
           /* fallback للمتصفحات القديمة */
           width: 55px;
           height: 55px;
           /* المتصفحات الحديثة */
           aspect-ratio: 1/1;
           min-height: 55px;
            max-width: 55px;
            background: var(--bg-input);
            border: 3px solid #444;
            border-radius: 8px;
            padding: 5px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        .parking-spot:hover {
            transform: scale(1.08);
            box-shadow: 0 0 25px rgba(255,215,0,0.6);
            z-index: 10;
        }

        .parking-spot.early {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            border-color: var(--green);
            box-shadow: 0 0 15px rgba(76,175,80,0.5);
        }

        .parking-spot.ontime {
            background: linear-gradient(135deg, #0d47a1, #1565c0);
            border-color: var(--blue);
            box-shadow: 0 0 15px rgba(33,150,243,0.5);
        }

        .parking-spot.late {
            background: linear-gradient(135deg, #b71c1c, #d32f2f);
            border-color: var(--red);
            animation: spot-pulse 0.6s infinite;
        }

        @keyframes spot-pulse {
            0%, 100% { box-shadow: 0 0 15px var(--red); transform: scale(1); }
            50% { box-shadow: 0 0 40px var(--red), 0 0 60px rgba(244,67,54,0.5); transform: scale(1.02); }
        }

        .parking-spot.empty {
            background: rgba(30,30,30,0.6);
            border-color: #333;
            opacity: 0.5;
        }

        .parking-spot.empty:hover { opacity: 0.8; }

        .spot-number {
            position: absolute;
            top: 3px;
            right: 3px;
            background: rgba(0,0,0,0.8);
            color: var(--primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .spot-badge {
            position: absolute;
            top: 3px;
            left: 3px;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.55rem;
            font-weight: 700;
            color: #fff;
        }

        .spot-badge.early { background: var(--green); }
        .spot-badge.ontime { background: var(--blue); }
        .spot-badge.late { background: var(--red); }

        .bus-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 2px;
            margin-top: 18px;
            font-size: 0.6rem;
            color: #fff;
        }

        .info-row {
            display: flex;
            align-items: center;
            gap: 3px;
            white-space: nowrap;
            overflow: hidden;
        }

        .info-icon { font-size: 0.7rem; }

        .countdown {
            text-align: center;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 3px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            margin-top: auto;
        }

        .empty-text {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #444;
            font-size: 1.5rem;
        }

        /* ═══════════════ قسم البوابات ═══════════════ */
        .gates-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border: 2px solid var(--primary);
        }

        .gates-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .gate-box {
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .gate-name {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .gate-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
        }

        /* ═══════════════ لوحة التحكم الجانبية ═══════════════ */
        /* ✅ إصلاح #1: تم إصلاح قيم CSS غير الصالحة */
        .control-panel {
            width: var(--panel-width);
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border-right: 3px solid var(--primary);
            padding: 15px;
            overflow-y: auto;
            transition: all 0.3s;
            position: relative;
            z-index: 100;
        }

        .control-panel.hidden {
            width: 0;
            padding: 0;
            overflow: hidden;
        }

        .panel-section {
            background: rgba(255,215,0,0.03);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .panel-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,215,0,0.3);
        }

        .panel-stat {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.85rem;
        }

        .panel-stat-value { color: var(--primary); font-weight: 700; }

        .panel-btn {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .panel-btn.primary {
            background: linear-gradient(135deg, var(--primary), #ffed4e);
            color: #000;
        }

        .panel-btn.success {
            background: linear-gradient(135deg, var(--green), #81c784);
            color: #fff;
        }

        .panel-btn.danger {
            background: linear-gradient(135deg, var(--red), #e57373);
            color: #fff;
        }

        .panel-btn.info {
            background: linear-gradient(135deg, var(--blue), #64b5f6);
            color: #fff;
        }

        .panel-btn.warning {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
            color: #000;
        }

        .panel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,215,0,0.4);
        }

        /* ═══════════════ تبويبات لوحة التحكم ═══════════════ */
        .panel-tabs {
            display: flex;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            border: 1px solid var(--primary);
        }

        .panel-tab {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            cursor: pointer;
            font-size: 0.7rem;
            color: var(--text-muted);
            transition: all 0.3s;
            border: none;
            background: transparent;
        }

        .panel-tab:hover {
            background: rgba(255,215,0,0.1);
            color: var(--primary);
        }

        .panel-tab.active {
            background: var(--primary);
            color: #000;
            font-weight: 700;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ═══════════════ عناصر الإعدادات ═══════════════ */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,215,0,0.1);
        }

        .setting-label {
            font-size: 0.8rem;
            color: var(--text);
        }

        .setting-input {
            width: 80px;
            padding: 5px;
            background: var(--bg-input);
            border: 1px solid var(--primary);
            border-radius: 4px;
            color: var(--primary);
            text-align: center;
            font-size: 0.85rem;
        }

        .setting-toggle {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--bg-input);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #444;
        }

        .setting-toggle.active {
            background: var(--green);
            border-color: var(--green);
        }

        .setting-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .setting-toggle.active::after {
            left: 27px;
        }

        .color-picker {
            width: 40px;
            height: 30px;
            border: 2px solid var(--primary);
            border-radius: 4px;
            cursor: pointer;
            padding: 0;
        }

        /* ═══════════════ قائمة التنبيهات ═══════════════ */
        .alerts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 8px;
            margin-bottom: 6px;
            border-radius: 6px;
            font-size: 0.75rem;
            border-right: 3px solid;
            background: rgba(0,0,0,0.3);
        }

        .alert-item.critical { border-color: var(--red); background: rgba(244,67,54,0.1); }
        .alert-item.warning { border-color: var(--orange); background: rgba(255,152,0,0.1); }
        .alert-item.info { border-color: var(--blue); background: rgba(33,150,243,0.1); }
        .alert-item.success { border-color: var(--green); background: rgba(76,175,80,0.1); }

        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .alert-title { font-weight: 700; }
        .alert-time { color: var(--text-muted); font-size: 0.65rem; }

        /* ═══════════════ مؤشرات الأداء ═══════════════ */
        .kpi-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            text-align: center;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .kpi-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s;
        }

        .chart-bars {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 80px;
            padding: 10px 0;
        }

        .chart-bar {
            width: 30%;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
        }

        .chart-bar-label {
            font-size: 0.6rem;
            color: var(--text);
            margin-top: 5px;
        }

        /* ═══════════════ النماذج ═══════════════ */
        .form-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .form-item:hover {
            background: rgba(255,215,0,0.1);
            border-color: var(--primary);
        }

        .form-icon {
            font-size: 1.2rem;
        }

        .form-name {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .form-desc {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* ═══════════════ إضافة حافلة ═══════════════ */
        .add-bus-section {
            background: rgba(0,0,0,0.3);
            border: 1px dashed var(--primary);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .add-bus-input {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--primary);
            border-radius: 4px;
            color: var(--text);
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .add-bus-input::placeholder {
            color: var(--text-muted);
        }

        .spot-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .spot-actions .panel-btn {
            flex: 1;
            padding: 6px;
            font-size: 0.75rem;
        }

        /* ═══════════════ قائمة الحافلات ═══════════════ */
        .bus-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .bus-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .bus-card:hover {
            background: rgba(255,215,0,0.1);
            border-color: var(--primary);
        }

        .bus-card.early { border-right: 3px solid var(--green); }
        .bus-card.ontime { border-right: 3px solid var(--blue); }
        .bus-card.late { border-right: 3px solid var(--red); }
        .bus-card.completed { border-right: 3px solid var(--green); background: rgba(76,175,80,0.1); }

        .bus-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .bus-card-plate {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.85rem;
        }

        .bus-card-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 700;
        }

        .bus-card-badge.early { background: var(--green); color: #fff; }
        .bus-card-badge.ontime { background: var(--blue); color: #fff; }
        .bus-card-badge.late { background: var(--red); color: #fff; }
        .bus-card-badge.completed { background: var(--green); color: #fff; }

        .bus-card-info {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .bus-card-progress {
            height: 4px;
            background: var(--bg-input);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }

        .bus-card-progress-fill {
            height: 100%;
            background: var(--green);
            border-radius: 2px;
            transition: width 0.3s;
        }

        .forms-badges {
            display: flex;
            gap: 3px;
            margin-top: 5px;
        }

        .form-badge {
            width: 18px;
            height: 18px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            background: var(--bg-input);
            color: var(--text-muted);
        }

        .form-badge.completed { background: var(--green); color: #fff; }
        .form-badge.pending { background: var(--orange); color: #fff; }

        /* ═══════════════ النافذة المنبثقة ═══════════════ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(255,215,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 2px solid var(--primary);
            background: rgba(255,215,0,0.1);
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-close:hover { color: var(--red); }

        .modal-body {
            padding: 15px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 15px;
            border-top: 1px solid rgba(255,215,0,0.3);
        }

        .modal-footer .panel-btn { margin-top: 0; }

        /* ═══════════════ حقول النموذج ═══════════════ */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: var(--primary);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-label.required::after {
            content: ' *';
            color: var(--red);
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(255,215,0,0.3);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group { flex: 1; }

        /* ═══════════════ قائمة اختيار النماذج ═══════════════ */
        .forms-menu {
            position: fixed;
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 10px;
            width: 220px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            z-index: 2500;
            display: none;
        }

        .forms-menu.active { display: block; }

        .forms-menu-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary);
            padding: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255,215,0,0.3);
        }

        .forms-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .forms-menu-item:hover {
            background: rgba(255,215,0,0.1);
        }

        .forms-menu-item-icon { font-size: 1.2rem; }
        .forms-menu-item-name { font-size: 0.8rem; flex: 1; }
        .forms-menu-item-status { font-size: 0.8rem; }

        /* ═══════════════ قسم البوابات المتقدم ═══════════════ */
        .gates-advanced {
            margin-top: 20px;
        }

        .gate-section {
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--primary);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .gate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255,215,0,0.1);
            border-bottom: 1px solid var(--primary);
            border-radius: 8px 8px 0 0;
        }

        .gate-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .gate-stats-mini {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
        }

        .gate-stats-mini span { padding: 2px 6px; border-radius: 4px; }
        .gate-stats-mini .early { background: var(--green); }
        .gate-stats-mini .ontime { background: var(--blue); }
        .gate-stats-mini .late { background: var(--red); }

        .gate-buses-list {
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
        }

        .gate-bus-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gate-bus-card:hover {
            background: rgba(255,215,0,0.1);
            transform: translateX(-5px);
        }

        .gate-bus-card.early { border-right: 3px solid var(--green); }
        .gate-bus-card.ontime { border-right: 3px solid var(--blue); }
        .gate-bus-card.late { border-right: 3px solid var(--red); animation: pulse-red 0.7s infinite; }

        /* ═══════════════ زر التبديل ═══════════════ */
        .toggle-btn {
            position: fixed;
            top: 120px;
            left: var(--panel-width);
            background: var(--primary);
            color: #000;
            padding: 15px 8px;
            cursor: pointer;
            z-index: 1001;
            border-radius: 0 8px 8px 0;
            font-weight: 700;
            writing-mode: vertical-rl;
            transition: all 0.3s;
            font-size: 0.8rem;
            border: none;
        }

        .toggle-btn:hover { padding-left: 15px; }
        .toggle-btn.shifted { left: 0; }

        /* ═══════════════ زر ملء الشاشة ═══════════════ */
        .fullscreen-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary);
            color: #000;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            z-index: 999;
            transition: all 0.3s;
        }

        .fullscreen-btn:hover { transform: scale(1.1); }

        /* ═══════════════ مفتاح الألوان ═══════════════ */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-color.green { background: var(--green); }
        .legend-color.blue { background: var(--blue); }
        .legend-color.red { background: var(--red); }
        .legend-color.empty { background: #333; border: 1px solid #555; }

        /* ═══════════════ التذييل ═══════════════ */
        .footer {
            background: linear-gradient(180deg, #1a1a1a, #0a0a0a);
            border-top: 3px solid var(--primary);
            padding: 10px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--primary);
        }

        /* ═══════════════ نافذة المعلومات ═══════════════ */
        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.95);
            border: 2px solid var(--primary);
            padding: 12px;
            border-radius: 8px;
            pointer-events: none;
            z-index: 2000;
            display: none;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(255,215,0,0.3);
        }

        .tooltip-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--primary);
        }

        .tooltip-row {
            font-size: 0.8rem;
            margin: 4px 0;
        }

        /* ═══════════════ الإشعارات ═══════════════ */
        .notifications {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1500;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .notification {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.85rem;
            animation: slideIn 0.4s ease;
            border-right: 4px solid;
            backdrop-filter: blur(10px);
            min-width: 280px;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { background: rgba(76,175,80,0.2); border-color: var(--green); }
        .notification.warning { background: rgba(255,152,0,0.2); border-color: var(--orange); }
        .notification.error { background: rgba(244,67,54,0.2); border-color: var(--red); }
        .notification.info { background: rgba(33,150,243,0.2); border-color: var(--blue); }

        /* ═══════════════ التجاوب ═══════════════ */
        @media (max-width: 1200px) {
            .parking-grid { grid-template-columns: repeat(7, 1fr); }
            .parking-grid.exit-grid { grid-template-columns: repeat(9, 1fr); }
            .gates-grid { grid-template-columns: repeat(5, 1fr); }
        }

        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .control-panel { width: 100%; position: fixed; bottom: 0; height: 50vh; }
            .parking-grid { grid-template-columns: repeat(4, 1fr); }
            .parking-grid.exit-grid { grid-template-columns: repeat(5, 1fr); }
        }
    </style>
</head>
<body>
    <!-- زر التبديل -->
    <button class="toggle-btn" id="toggleBtn" onclick="togglePanel()">التحكم</button>

    <!-- زر ملء الشاشة -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()">⛶ ملء الشاشة</button>

    <!-- الرأسية -->
    <header class="header">
        <div class="header-title">إدارة عمليات الساحات الخارجية والمواصلات</div>
        <div class="header-company">JEDCO</div>
        <div class="header-info">
            <div class="info-box">
                <div class="info-box-label">الوقت</div>
                <div class="info-box-value" id="currentTime">--:--:--</div>
            </div>
            <div class="info-box" id="shiftBox">
                <div class="info-box-label">النوبة</div>
                <div class="info-box-value" id="currentShift">-</div>
            </div>
            <div class="info-box">
                <div class="info-box-label">التاريخ</div>
                <div class="info-box-value" id="currentDate">----/--/--</div>
            </div>
        </div>
    </header>

    <!-- شريط الإحصائيات الموحد -->
    <div class="unified-stats-bar">
        <!-- الإحصائيات الحالية -->
        <div class="stats-group">
            <div class="mini-stat" onclick="filterBuses('all')"><span class="mini-label">الحافلات</span><div class="mini-box"><span class="mini-value" id="totalBuses">0</span></div></div>
            <div class="mini-stat green" onclick="filterBuses('early')"><span class="mini-label">مبكر</span><div class="mini-box"><span class="mini-value" id="earlyBuses">0</span></div></div>
            <div class="mini-stat blue" onclick="filterBuses('ontime')"><span class="mini-label">موعد</span><div class="mini-box"><span class="mini-value" id="ontimeBuses">0</span></div></div>
            <div class="mini-stat red" onclick="filterBuses('late')"><span class="mini-label">متأخر</span><div class="mini-box"><span class="mini-value" id="lateBuses">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">ركاب</span><div class="mini-box"><span class="mini-value" id="totalPax">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">رحلات</span><div class="mini-box"><span class="mini-value" id="totalFlights">0</span></div></div>
        </div>
        <div class="stats-divider"></div>
        <!-- إحصائيات اليوم -->
        <div class="stats-group">
            <div class="mini-stat"><span class="mini-label">اليوم</span><div class="mini-box"><span class="mini-value" id="dailyBuses">0</span></div></div>
            <div class="mini-stat green"><span class="mini-label">مبكر</span><div class="mini-box"><span class="mini-value" id="dailyEarly">0</span></div></div>
            <div class="mini-stat blue"><span class="mini-label">موعد</span><div class="mini-box"><span class="mini-value" id="dailyOntime">0</span></div></div>
            <div class="mini-stat red"><span class="mini-label">متأخر</span><div class="mini-box"><span class="mini-value" id="dailyLate">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">ركاب</span><div class="mini-box"><span class="mini-value" id="dailyPax">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">رحلات</span><div class="mini-box"><span class="mini-value" id="dailyFlights">0</span></div></div>
        </div>
        <div class="stats-divider"></div>
        <!-- حافلات التأشيرات -->
        <div class="stats-group">
            <div class="mini-stat"><span class="mini-label">حج</span><div class="mini-box"><span class="mini-value" id="visaHajj">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">عمرة</span><div class="mini-box"><span class="mini-value" id="visaUmrah">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">زيارة</span><div class="mini-box"><span class="mini-value" id="visaVisit">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">سياحة</span><div class="mini-box"><span class="mini-value" id="visaTourism">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">خليجي</span><div class="mini-box"><span class="mini-value" id="visaGCC">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">عمل</span><div class="mini-box"><span class="mini-value" id="visaWork">0</span></div></div>
        </div>
        <div class="stats-divider"></div>
        <!-- ركاب التأشيرات -->
        <div class="stats-group">
            <div class="mini-stat"><span class="mini-label">ركاب حج</span><div class="mini-box"><span class="mini-value" id="visaPaxHajj">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">ركاب عمرة</span><div class="mini-box"><span class="mini-value" id="visaPaxUmrah">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">ركاب زيارة</span><div class="mini-box"><span class="mini-value" id="visaPaxVisit">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">ركاب سياحة</span><div class="mini-box"><span class="mini-value" id="visaPaxTourism">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">ركاب خليجي</span><div class="mini-box"><span class="mini-value" id="visaPaxGCC">0</span></div></div>
            <div class="mini-stat"><span class="mini-label">ركاب عمل</span><div class="mini-box"><span class="mini-value" id="visaPaxWork">0</span></div></div>
        </div>
    </div>

    <!-- مفتاح الألوان -->
    <div class="legend">
        <!-- ✅ إصلاح #36: توضيح Legend ليتطابق مع منطق الكود -->
        <div class="legend-item"><div class="legend-color green"></div><span>مبكر (أكثر من 7 ساعات)</span></div>
        <div class="legend-item"><div class="legend-color blue"></div><span>في الموعد (3 إلى 7 ساعات)</span></div>
        <div class="legend-item"><div class="legend-color red"></div><span>متأخر (أقل من 3 ساعات)</span></div>
        <div class="legend-item"><div class="legend-color empty"></div><span>فارغ</span></div>
    </div>

    <!-- الحاوية الرئيسية -->
    <div class="main-container">
        <!-- منطقة المحتوى -->
        <div class="content-area">
            <!-- حاوية المواقف الأفقية -->
            <div class="parking-container">
                <!-- جهة المدخل -->
                <div class="parking-section">
                    <div class="section-title">جهة المدخل (42 موقف)</div>
                    <div class="parking-grid" id="entranceGrid"></div>
                </div>

                <!-- جهة المخرج -->
                <div class="parking-section">
                    <div class="section-title">جهة المخرج (45 موقف)</div>
                    <div class="parking-grid exit-grid" id="exitGrid"></div>
                </div>
            </div>

            <!-- قسم البوابات -->
            <div class="gates-section">
                <div class="section-title">بوابات صالة المغادرة</div>
                <div class="gates-grid" id="gatesGrid"></div>
            </div>
        </div>

        <!-- لوحة التحكم -->
        <div class="control-panel" id="controlPanel">
            <!-- التبويبات -->
            <div class="panel-tabs">
                <button class="panel-tab active" onclick="showTab('main', event)" title="الرئيسية">رئيسية</button>
                <button class="panel-tab" onclick="showTab('settings', event)" title="الإعدادات">إعدادات</button>
                <button class="panel-tab" onclick="showTab('alerts', event)" title="التنبيهات">تنبيهات</button>
                <button class="panel-tab" onclick="showTab('kpis', event)" title="المؤشرات">مؤشرات</button>
                <button class="panel-tab" onclick="showTab('forms', event)" title="النماذج">نماذج</button>
                <button class="panel-tab" onclick="showTab('registered', event)" title="المسجلة">مسجلة</button>
                <button class="panel-tab" onclick="showTab('segregation', event)" title="الفرز">فرز</button>
                <button class="panel-tab" onclick="showTab('departed', event)" title="غادرت">غادرت</button>
            </div>

            <!-- Tab 1: الرئيسية -->
            <div class="tab-content active" id="tab-main">
                <div class="panel-section">
                    <div class="panel-title">الإحصائيات</div>
                    <div class="panel-stat"><span>المواقف:</span><span class="panel-stat-value">87</span></div>
                    <div class="panel-stat"><span>مشغول:</span><span class="panel-stat-value" id="panelOccupied">0</span></div>
                    <div class="panel-stat"><span>فارغ:</span><span class="panel-stat-value" id="panelEmpty">87</span></div>
                    <div class="panel-stat"><span>مبكر:</span><span class="panel-stat-value" style="color:var(--green)" id="panelEarly">0</span></div>
                    <div class="panel-stat"><span>موعد:</span><span class="panel-stat-value" style="color:var(--blue)" id="panelOntime">0</span></div>
                    <div class="panel-stat"><span>متأخر:</span><span class="panel-stat-value" style="color:var(--red)" id="panelLate">0</span></div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">التكبير</div>
                    <div style="display:flex;gap:5px;">
                        <button class="panel-btn primary" onclick="zoomOut()" style="flex:1">➖</button>
                        <button class="panel-btn primary" onclick="zoomReset()" style="flex:1" id="zoomLevel">100%</button>
                        <button class="panel-btn primary" onclick="zoomIn()" style="flex:1">➕</button>
                    </div>
                    <div class="panel-section">
                    <div class="panel-title">حجم المواقف</div>
                    <div style="display:flex;gap:5px;">
                        <button class="panel-btn primary" onclick="spotSizeOut()" style="flex:1">➖</button>
                        <button class="panel-btn primary" style="flex:1" id="spotSizeLevel">55px</button>
                        <button class="panel-btn primary" onclick="spotSizeIn()" style="flex:1">➕</button>
                    </div>
                    <input type="range" min="40" max="100" value="55" style="width:100%;margin-top:8px;" onchange="setSpotSize(this.value)" id="spotSizeSlider">
                </div>
                    <input type="range" min="50" max="150" value="100" style="width:100%;margin-top:8px;" onchange="setZoom(this.value)" id="zoomSlider">
                </div>

                <div class="panel-section">
                    <div class="panel-title">التحرير</div>
                    <button class="panel-btn success" onclick="toggleEditMode()" id="editBtn">تفعيل وضع التحرير</button>
                    
                    <div class="add-bus-section">
                        <div style="font-size:0.8rem;color:var(--primary);margin-bottom:8px;">إضافة حافلة جديدة</div>
                        <input type="number" class="add-bus-input" placeholder="رقم الموقف (1-87)" id="newSpotNumber" min="1" max="87">
                        <button class="panel-btn primary" onclick="addNewBus()">إضافة حافلة جديدة</button>
                    </div>

                    <div id="spotActions" style="display:none;margin-top:10px;">
                        <div style="font-size:0.8rem;color:var(--primary);margin-bottom:8px;">الموقف المحدد: <span id="selectedSpotNum">-</span></div>
                        <div class="spot-actions">
                            <button class="panel-btn info" onclick="editSpot()">تعديل</button>
                            <button class="panel-btn primary" onclick="moveSpot()">نقل</button>
                            <button class="panel-btn danger" onclick="deleteSpot()">حذف</button>
                        </div>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">البيانات</div>
                    <button class="panel-btn primary" onclick="exportJSON()">تصدير JSON</button>
                    <button class="panel-btn info" onclick="exportCSV()">تصدير CSV</button>
                    <button class="panel-btn primary" onclick="document.getElementById('importFile').click()">استيراد</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
                    <button class="panel-btn danger" onclick="resetAll()">مسح الكل</button>
                    <button class="panel-btn warning" onclick="clearAllData()">تصفير البيانات</button>
                    <button class="panel-btn" style="background:linear-gradient(135deg,#9c27b0,#ba68c8);" onclick="loadTestData()">تحميل 20 حافلة تجريبية</button>
                </div>
            </div>

            <!-- Tab 2: الإعدادات -->
            <div class="tab-content" id="tab-settings">
                <div class="panel-section">
                    <div class="panel-title">إعدادات الوقت</div>
                    <div class="setting-row">
                        <span class="setting-label">حد المبكر (ساعة)</span>
                        <input type="number" class="setting-input" value="7" min="1" max="24" id="earlyThreshold" onchange="updateThresholds()">
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">حد المتأخر (ساعة)</span>
                        <input type="number" class="setting-input" value="3" min="1" max="12" id="lateThreshold" onchange="updateThresholds()">
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">إعدادات الألوان</div>
                    <div class="setting-row">
                        <span class="setting-label">اللون الأساسي</span>
                        <input type="color" class="color-picker" value="#ffd700" id="colorPrimary" onchange="updateColors()">
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">لون المبكر</span>
                        <input type="color" class="color-picker" value="#4caf50" id="colorEarly" onchange="updateColors()">
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">لون في الموعد</span>
                        <input type="color" class="color-picker" value="#2196f3" id="colorOntime" onchange="updateColors()">
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">لون المتأخر</span>
                        <input type="color" class="color-picker" value="#f44336" id="colorLate" onchange="updateColors()">
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">إعدادات التنبيهات</div>
                    <div class="setting-row">
                        <span class="setting-label">تفعيل الصوت</span>
                        <div class="setting-toggle" id="soundToggle" onclick="toggleSetting('sound')"></div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">إشعارات منبثقة</span>
                        <div class="setting-toggle active" id="notifToggle" onclick="toggleSetting('notif')"></div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">تحديث تلقائي</span>
                        <div class="setting-toggle active" id="autoRefreshToggle" onclick="toggleSetting('autoRefresh')"></div>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">إعدادات العرض</div>
                    <div class="setting-row">
                        <span class="setting-label">حجم المواقف (px)</span>
                        <input type="number" class="setting-input" value="80" min="60" max="120" id="spotSize" onchange="updateSpotSize()">
                    </div>
                </div>

                <div class="panel-section">
                    <button class="panel-btn success" onclick="saveSettings()">حفظ الإعدادات</button>
                    <button class="panel-btn primary" onclick="loadSettings()">تحميل الإعدادات</button>
                    <button class="panel-btn danger" onclick="resetSettings()">إعادة التعيين</button>
                </div>
            </div>

            <!-- Tab 3: التنبيهات -->
            <div class="tab-content" id="tab-alerts">
                <div class="panel-section">
                    <div class="panel-title" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>التنبيهات النشطة (<span id="alertsCount">0</span>)</span>
                    </div>
                    <div style="display:flex;gap:5px;margin-bottom:10px;">
                        <button class="panel-btn danger" onclick="clearAlerts()" style="flex:1;padding:6px;font-size:0.75rem;">مسح</button>
                        <button class="panel-btn info" onclick="testAlert()" style="flex:1;padding:6px;font-size:0.75rem;">اختبار</button>
                    </div>
                    <div class="alerts-list" id="alertsList">
                        <div style="text-align:center;color:var(--text-muted);padding:20px;">لا توجد تنبيهات</div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: مؤشرات الأداء -->
            <div class="tab-content" id="tab-kpis">
                <div class="panel-section">
                    <div class="panel-title">مؤشرات الأداء</div>
                    
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiOccupancy">0%</div>
                        <div class="kpi-label">نسبة الإشغال</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="occupancyBar" style="width:0%;background:var(--blue);"></div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiAvgWait">0</div>
                        <div class="kpi-label">متوسط وقت الانتظار (دقيقة)</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-label" style="margin-bottom:5px;">توزيع الحالات</div>
                        <div class="chart-bars">
                            <div class="chart-bar" id="barEarly" style="height:30%;background:var(--green);">
                                <span class="chart-bar-label">مبكر</span>
                            </div>
                            <div class="chart-bar" id="barOntime" style="height:40%;background:var(--blue);">
                                <span class="chart-bar-label">موعد</span>
                            </div>
                            <div class="chart-bar" id="barLate" style="height:30%;background:var(--red);">
                                <span class="chart-bar-label">متأخر</span>
                            </div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiOnTimeRate">0%</div>
                        <div class="kpi-label">معدل التفويج بالموعد</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="onTimeBar" style="width:0%;background:var(--green);"></div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiAvgPax">0</div>
                        <div class="kpi-label">متوسط الركاب/حافلة</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiPeakOccupancy">0%</div>
                        <div class="kpi-label">ذروة الإشغال اليوم</div>
                    </div>

                    <div style="display:flex;gap:8px;">
                        <div class="kpi-card" style="flex:1;">
                            <div class="kpi-value" id="kpiBusesToday">0</div>
                            <div class="kpi-label">حافلات اليوم</div>
                        </div>
                        <div class="kpi-card" style="flex:1;">
                            <div class="kpi-value" id="kpiPaxToday">0</div>
                            <div class="kpi-label">مسافرين اليوم</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: النماذج -->
            <div class="tab-content" id="tab-forms">
                <div class="panel-section">
                    <div class="panel-title">النماذج المتاحة</div>
                    <div class="form-list">
                        <div class="form-item" onclick="openForm('ScrLogIn')">
                            <span class="form-icon">1</span>
                            <div>
                                <div class="form-name">تسجيل الدخول</div>
                                <div class="form-desc">ScrLogIn - اختيار موقع العمل</div>
                            </div>
                        </div>
                        <div class="form-item" onclick="openForm('ScrSegregationIn')">
                            <span class="form-icon">2</span>
                            <div>
                                <div class="form-name">دخول الفصل</div>
                                <div class="form-desc">ScrSegregationIn - تسجيل دخول الحافلات</div>
                            </div>
                        </div>
                        <div class="form-item" onclick="openForm('ScrWelcomeLounge')">
                            <span class="form-icon">3</span>
                            <div>
                                <div class="form-name">صالة الانتظار</div>
                                <div class="form-desc">ScrWelcomeLounge - إدارة المواقف</div>
                            </div>
                        </div>
                        <div class="form-item" onclick="openForm('ScrSegregationExit')">
                            <span class="form-icon">4</span>
                            <div>
                                <div class="form-name">خروج الفصل</div>
                                <div class="form-desc">ScrSegregationExit - تسجيل الخروج</div>
                            </div>
                        </div>
                        <div class="form-item" onclick="openForm('ScrCurbside')">
                            <span class="form-icon">5</span>
                            <div>
                                <div class="form-name">الرصيف</div>
                                <div class="form-desc">ScrCurbside - منطقة الصعود</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 6: الحافلات المسجلة -->
            <div class="tab-content" id="tab-registered">
                <div class="panel-section">
                    <div class="panel-title">الحافلات المسجلة (<span id="registeredCount">0</span>)</div>
                    <div class="bus-list" id="registeredList">
                        <div style="text-align:center;color:var(--text-muted);padding:20px;">لا توجد حافلات مسجلة</div>
                    </div>
                </div>
            </div>

            <!-- Tab 7: ScrSegregationIn -->
            <div class="tab-content" id="tab-segregation">
                <div class="panel-section">
                    <div class="panel-title">حافلات الفرز (<span id="segregationCount">0</span>)</div>
                    <div class="bus-list" id="segregationList">
                        <div style="text-align:center;color:var(--text-muted);padding:20px;">لا توجد حافلات في الفرز</div>
                    </div>
                </div>
            </div>

            <!-- Tab 8: حافلات غادرت -->
            <div class="tab-content" id="tab-departed">
                <div class="panel-section">
                    <div class="panel-title">حافلات غادرت (<span id="departedCount">0</span>)</div>
                    <div style="display:flex;gap:5px;margin-bottom:10px;">
                        <div class="kpi-card" style="flex:1;padding:5px;">
                            <div class="kpi-value" style="font-size:1rem;" id="departedToday">0</div>
                            <div class="kpi-label">اليوم</div>
                        </div>
                        <div class="kpi-card" style="flex:1;padding:5px;">
                            <div class="kpi-value" style="font-size:1rem;" id="departedPax">0</div>
                            <div class="kpi-label">الركاب</div>
                        </div>
                    </div>
                    <div class="bus-list" id="departedList">
                        <div style="text-align:center;color:var(--text-muted);padding:20px;">لا توجد حافلات غادرت</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- التذييل -->
    <footer class="footer">
        إدارة عمليات الساحات الخارجية والمواصلات v3.0 | LOCC System | آخر تحديث: <span id="lastUpdate">--:--:--</span>
    </footer>

    <!-- نافذة المعلومات -->
    <div class="tooltip" id="tooltip"></div>

    <!-- الإشعارات -->
    <div class="notifications" id="notifications"></div>

    <!-- قائمة اختيار النماذج -->
    <div class="forms-menu" id="formsMenu">
        <div class="forms-menu-title">اختر النموذج</div>
        <div class="forms-menu-item" onclick="selectFormFromMenu('ScrLogIn')">
            <span class="forms-menu-item-icon">1</span>
            <span class="forms-menu-item-name">ScrLogIn</span>
            <span class="forms-menu-item-status" id="formStatus1">-</span>
        </div>
        <div class="forms-menu-item" onclick="selectFormFromMenu('ScrSegregationIn')">
            <span class="forms-menu-item-icon">2</span>
            <span class="forms-menu-item-name">ScrSegregationIn</span>
            <span class="forms-menu-item-status" id="formStatus2">-</span>
        </div>
        <div class="forms-menu-item" onclick="selectFormFromMenu('ScrWelcomeLounge')">
            <span class="forms-menu-item-icon">3</span>
            <span class="forms-menu-item-name">ScrWelcomeLounge</span>
            <span class="forms-menu-item-status" id="formStatus3">-</span>
        </div>
        <div class="forms-menu-item" onclick="selectFormFromMenu('ScrSegregationExit')">
            <span class="forms-menu-item-icon">4</span>
            <span class="forms-menu-item-name">ScrSegregationExit</span>
            <span class="forms-menu-item-status" id="formStatus4">-</span>
        </div>
        <div class="forms-menu-item" onclick="selectFormFromMenu('ScrCurbside')">
            <span class="forms-menu-item-icon">5</span>
            <span class="forms-menu-item-name">ScrCurbside</span>
            <span class="forms-menu-item-status" id="formStatus5">-</span>
        </div>
    </div>

    <!-- النافذة المنبثقة للنماذج -->
    <div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
        <div class="modal" id="formModal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">النموذج</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- محتوى النموذج يُحقن هنا -->
            </div>
            <div class="modal-footer">
                <button class="panel-btn primary" onclick="saveFormData()" style="flex:1;">💾 حفظ</button>
                <button class="panel-btn danger" onclick="closeModal()" style="flex:1;">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // ✅ إصلاح #34: تغليف المتغيرات في IIFE لمنع التلوث العام
        (function(window, document) {
            'use strict';
            
        // ═══════════════ المتغيرات العامة ═══════════════
        var busData = [];
        // ✅ إصلاح #37: تم إزالة busRecords (كان Dead Code)
        var departedBuses = [];
        // ✅ إصلاح #38: تم إزالة gateStats (كان Dead Code)
        var dailyStats = { buses: 0, pax: 0, early: 0, ontime: 0, late: 0, flights: new Set() };
        var zoomLevel = 100;
        var editMode = false;
        var panelVisible = true;
        var thresholds = { early: 7, late: 3 };
        var currentSpotForForm = null;
        var currentBusForForm = null;
        var currentFormName = null;
        
        // ✅ إصلاح #56: متغيرات لتتبع intervals ومنع تسريب الذاكرة
        var intervalIds = {
            updateTime: null,
            updateCountdowns: null,
            saveData: null
        };

        // ═══════════════ البوابات ═══════════════
        var gates = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2', 'D1', 'D2', 'E1', 'E2'];

        // ✅ إصلاح #2: دالة آمنة لتحليل JSON مع معالجة الأخطاء
        function safeJSONParse(jsonString, defaultValue) {
            if (defaultValue === undefined) { defaultValue = null; }
            if (!jsonString || typeof jsonString !== 'string') {
                return defaultValue;
            }
            try {
                return JSON.parse(jsonString);
            } catch (error) {
                console.error('خطأ في تحليل JSON:', error.message);
                return defaultValue;
            }
        }

        // ✅ إصلاح #3: دالة آمنة لتحويل إلى JSON
        function safeJSONStringify(data, defaultValue) {
            if (defaultValue === undefined) { defaultValue = '{}'; }
            try {
                return JSON.stringify(data);
            } catch (error) {
                console.error('خطأ في تحويل إلى JSON:', error.message);
                return defaultValue;
            }
        }

        // ✅ إصلاح #55: دوال تشفير وفك تشفير آمنة باستخدام Web Crypto API
        // تشفير AES-GCM مع Salt عشوائي و 600,000 iterations (معيار 2025)
        // المصدر: MDN Web Crypto API + OWASP Guidelines

        var CRYPTO_CONFIG = {
            iterations: 600000,  // معيار 2025 ضد Brute-force
            keyLength: 256,      // AES-256
            ivLength: 12,        // 96-bit IV لـ AES-GCM
            saltLength: 16       // 128-bit Salt عشوائي
        };

        // مفتاح ثابت للتشفير المحلي (يمكن تغييره)
        var ENCRYPTION_PASSWORD = 'LOCC_2024_SECURE_KEY';

        // تحويل ArrayBuffer إلى Base64
        function arrayBufferToBase64(buffer) {
            var bytes = new Uint8Array(buffer);
            var binary = '';
            for (var i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // تحويل Base64 إلى ArrayBuffer
        function base64ToArrayBuffer(base64) {
            var binary = atob(base64);
            var bytes = new Uint8Array(binary.length);
            for (var i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // اشتقاق مفتاح التشفير من كلمة المرور باستخدام PBKDF2
        async function deriveKey(password, salt) {
            var enc = new TextEncoder();
            var keyMaterial = await crypto.subtle.importKey(
                'raw',
                enc.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );
            return await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: CRYPTO_CONFIG.iterations,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: CRYPTO_CONFIG.keyLength },
                false,
                ['encrypt', 'decrypt']
            );
        }

        // تشفير آمن باستخدام AES-GCM
        async function secureEncrypt(text) {
            if (!text) return '';
            try {
                var enc = new TextEncoder();
                // توليد Salt عشوائي لكل عملية تشفير
                var salt = crypto.getRandomValues(new Uint8Array(CRYPTO_CONFIG.saltLength));
                // توليد IV عشوائي
                var iv = crypto.getRandomValues(new Uint8Array(CRYPTO_CONFIG.ivLength));
                // اشتقاق المفتاح
                var key = await deriveKey(ENCRYPTION_PASSWORD, salt);
                // التشفير
                var encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    enc.encode(text)
                );
                // دمج Salt + IV + البيانات المشفرة
                var combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.length);
                combined.set(new Uint8Array(encrypted), salt.length + iv.length);
                return 'V2:' + arrayBufferToBase64(combined.buffer);
            } catch (e) {
                console.error('خطأ في التشفير:', e);
                return '';
            }
        }

        // فك التشفير الآمن
        async function secureDecrypt(encoded) {
            if (!encoded) return '';

            // ✅ التوافق مع البيانات القديمة (JSON غير مشفر)
            if (encoded.charAt(0) === '{' || encoded.charAt(0) === '[') {
                return encoded;
            }

            // ✅ التوافق مع التشفير القديم (XOR)
            if (!encoded.startsWith('V2:')) {
                return legacyDecrypt(encoded);
            }

            try {
                var data = encoded.substring(3); // إزالة 'V2:'
                var combined = new Uint8Array(base64ToArrayBuffer(data));
                // استخراج Salt + IV + البيانات
                var salt = combined.slice(0, CRYPTO_CONFIG.saltLength);
                var iv = combined.slice(CRYPTO_CONFIG.saltLength, CRYPTO_CONFIG.saltLength + CRYPTO_CONFIG.ivLength);
                var encryptedData = combined.slice(CRYPTO_CONFIG.saltLength + CRYPTO_CONFIG.ivLength);
                // اشتقاق المفتاح
                var key = await deriveKey(ENCRYPTION_PASSWORD, salt);
                // فك التشفير
                var decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encryptedData
                );
                return new TextDecoder().decode(decrypted);
            } catch (e) {
                console.error('خطأ في فك التشفير:', e);
                return encoded;
            }
        }

        // دالة التشفير القديم للتوافق العكسي
        var STORAGE_KEY = 'LOCC_2024';
        function legacyDecrypt(encoded) {
            if (!encoded) return '';
            var base64Regex = /^[A-Za-z0-9+/=]+$/;
            if (!base64Regex.test(encoded)) return encoded;
            try {
                var text;
                try { text = decodeURIComponent(atob(encoded)); }
                catch (e) { text = atob(encoded); }
                var result = '';
                for (var i = 0; i < text.length; i++) {
                    var charCode = text.charCodeAt(i) ^ STORAGE_KEY.charCodeAt(i % STORAGE_KEY.length);
                    result += String.fromCharCode(charCode);
                }
                return result;
            } catch (e) { return encoded; }
        }

        // دوال متزامنة للتوافق مع الكود الحالي
        var encryptionQueue = Promise.resolve();

        function simpleEncrypt(text) {
            // تشفير مؤقت متزامن - سيتم استبداله بالتشفير الآمن
            if (!text) return '';
            encryptionQueue = encryptionQueue.then(function() {
                return secureEncrypt(text).then(function(encrypted) {
                    if (encrypted) {
                        localStorage.setItem('LOCC_Data', encrypted);
                        localStorage.setItem('LOCC_Checksum', simpleChecksum(encrypted));
                    }
                });
            });
            // إرجاع placeholder - البيانات ستُحفظ async
            return 'ASYNC_ENCRYPT';
        }

        function simpleDecrypt(encoded) {
            // للتوافق: فك التشفير المتزامن للبيانات القديمة
            if (!encoded) return '';
            if (encoded === 'ASYNC_ENCRYPT') return '';
            if (encoded.charAt(0) === '{' || encoded.charAt(0) === '[') return encoded;
            if (!encoded.startsWith('V2:')) return legacyDecrypt(encoded);
            // V2 يحتاج async - سيتم معالجته في loadData
            return '';
        }

        // ✅ إصلاح #4: دالة آمنة للوصول إلى عناصر DOM
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn('العنصر غير موجود:', id);
            }
            return element;
        }

        // ✅ إصلاح #5: دالة آمنة لتعيين محتوى النص
        function safeSetText(id, text) {
            const element = safeGetElement(id);
            if (element) {
                element.textContent = String(text);
            }
        }

        // ✅ إصلاح #56: تم حذف safeSetHTML (كانت Dead Code - غير مستخدمة)

        // ✅ إصلاح #7: دالة لتنظيف المدخلات من XSS
        function sanitizeInput(input) {
            if (typeof input !== 'string') return String(input);
            return input
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;');
        }

        // ✅ إصلاح #8: التحقق من صحة رقم الموقف
        function validateSpotNumber(spotNum) {
            const num = parseInt(spotNum, 10);
            return !isNaN(num) && num >= 1 && num <= 87;
        }

        // ✅ إصلاح #9: التحقق من صحة بيانات الحافلة
        function validateBusData(bus) {
            if (!bus || typeof bus !== 'object') return false;
            if (!bus.plate || typeof bus.plate !== 'string') return false;
            if (bus.pax !== undefined && (typeof bus.pax !== 'number' || bus.pax < 0)) return false;
            return true;
        }

        // ═══════════════ تهيئة النظام ═══════════════
        // ✅ إصلاح #55: تهيئة النظام async لدعم التشفير الآمن
        async function init() {
            try {
                // ✅ انتظار تحميل البيانات المشفرة
                await loadData();
                loadSettings();

                // تحميل بيانات تجريبية إذا لم توجد بيانات
                if (busData.length === 0) {
                    loadTestData();
                }

                // عرض المواقف والبوابات بعد تحميل البيانات
                renderParkingGrid('entranceGrid', 1, 42);
                renderParkingGrid('exitGrid', 43, 87);
                renderGates();
                updateStats();
                updateKPIs();
                updateBusLists();
                updateTime();

                // ✅ إصلاح #56: تنظيف intervals السابقة قبل إنشاء جديدة
                if (intervalIds.updateTime) clearInterval(intervalIds.updateTime);
                if (intervalIds.updateCountdowns) clearInterval(intervalIds.updateCountdowns);
                if (intervalIds.saveData) clearInterval(intervalIds.saveData);

                // حفظ معرفات intervals للتنظيف لاحقاً
                intervalIds.updateTime = setInterval(updateTime, 1000);
                intervalIds.updateCountdowns = setInterval(updateCountdowns, 1000);
                intervalIds.saveData = setInterval(saveData, 30000);

                console.log('✅ تم تهيئة النظام بنجاح مع تشفير AES-GCM آمن');
            } catch (error) {
                console.error('خطأ في تهيئة النظام:', error);
                showNotification('error', 'خطأ', 'فشل في تهيئة النظام');
            }
        }
        
        // ═══════════════ بيانات تجريبية - 20 حافلة ═══════════════
        function loadTestData() {
            try {
                const now = new Date();
                const visaTypes = ['Hajj', 'Umrah', 'Visit', 'Tourism', 'GCC', 'Work'];
                const terminals = ['HT', 'NT', 'T1'];
                const gatesArr = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2', 'D1', 'D2', 'E1', 'E2'];
                
                // 10 حافلات متأخرة (وقت المغادرة قبل 1-2 ساعة - أقل من 3 ساعات)
                for (let i = 1; i <= 10; i++) {
                    const hoursAgo = 1 + Math.random() * 2;
                    const depTime = new Date(now.getTime() - hoursAgo * 60 * 60000);
                    busData.push({
                        id: Date.now() + i,
                        plate: 'L' + (1000 + i) + 'SRA',
                        busNo: 100 + i,
                        flight: 'SV' + (1000 + i),
                        pax: 30 + Math.floor(Math.random() * 20),
                        visa: visaTypes[i % 6],
                        terminal: terminals[i % 3],
                        destination: 'مكة المكرمة',
                        departure: depTime.toISOString(),
                        arrival: new Date(now.getTime() - 8 * 60 * 60000).toISOString(),
                        spot: i,
                        gate: gatesArr[i % 10],
                        forms: { ScrSegregationIn: {}, ScrWelcomeLounge: {} }
                    });
                    dailyStats.late++;
                }
                
                // 5 حافلات في الموعد
                for (let i = 11; i <= 15; i++) {
                    const hoursLeft = 4 + Math.random() * 2;
                    const depTime = new Date(now.getTime() + hoursLeft * 60 * 60000);
                    busData.push({
                        id: Date.now() + i,
                        plate: 'O' + (1000 + i) + 'SRA',
                        busNo: 100 + i,
                        flight: 'SV' + (1000 + i),
                        pax: 30 + Math.floor(Math.random() * 20),
                        visa: visaTypes[i % 6],
                        terminal: terminals[i % 3],
                        destination: 'المدينة المنورة',
                        departure: depTime.toISOString(),
                        arrival: new Date(now.getTime() - 4 * 60 * 60000).toISOString(),
                        spot: i,
                        gate: gatesArr[i % 10],
                        forms: { ScrSegregationIn: {}, ScrWelcomeLounge: {} }
                    });
                    dailyStats.ontime++;
                }
                
                // 5 حافلات مبكر
                for (let i = 16; i <= 20; i++) {
                    const hoursLeft = 8 + Math.random() * 4;
                    const depTime = new Date(now.getTime() + hoursLeft * 60 * 60000);
                    busData.push({
                        id: Date.now() + i,
                        plate: 'E' + (1000 + i) + 'SRA',
                        busNo: 100 + i,
                        flight: 'SV' + (1000 + i),
                        pax: 30 + Math.floor(Math.random() * 20),
                        visa: visaTypes[i % 6],
                        terminal: terminals[i % 3],
                        destination: 'جدة',
                        departure: depTime.toISOString(),
                        arrival: new Date(now.getTime() - 2 * 60 * 60000).toISOString(),
                        spot: i,
                        gate: gatesArr[i % 10],
                        forms: { ScrSegregationIn: {}, ScrWelcomeLounge: {} }
                    });
                    dailyStats.early++;
                }
                
                dailyStats.buses = 20;
                dailyStats.pax = busData.reduce(function(sum, b) { return sum + (b.pax || 0); }, 0);
                busData.forEach(function(b) { dailyStats.flights.add(b.flight); });
                
                updateStats();
                renderParkingGrid('entranceGrid', 1, 42);
                renderParkingGrid('exitGrid', 43, 87);
                renderGates();
                updateKPIs();
                saveData();
                
                showNotification('success', 'بيانات تجريبية', 'تم تحميل 20 حافلة: 10 متأخرة، 5 في الموعد، 5 مبكر');
            } catch (error) {
                console.error('خطأ في تحميل البيانات التجريبية:', error);
                showNotification('error', 'خطأ', 'فشل في تحميل البيانات التجريبية');
            }
        }

        // ═══════════════ عرض شبكة المواقف ═══════════════
        function renderParkingGrid(containerId, start, end) {
            const container = safeGetElement(containerId);
            if (!container) return;
            
            container.innerHTML = '';

            for (let i = start; i <= end; i++) {
                const spot = document.createElement('div');
                spot.className = 'parking-spot';
                spot.dataset.spot = i;

                const bus = busData.find(function(b) { return b.spot === i; });

                if (bus) {
                    const status = getStatus(bus.arrival, bus.departure);
                    spot.classList.add(status.class);
                    const countdown = getCountdownString(bus.departure);

                    // ✅ إصلاح #10: استخدام sanitizeInput للبيانات المعروضة
                    spot.innerHTML = 
                        '<div class="spot-number">#' + i + '</div>' +
                        '<div class="spot-badge ' + status.class + '">' + sanitizeInput(status.label) + '</div>' +
                        '<div class="bus-info">' +
                            '<div class="info-row"><span class="info-icon">B</span>' + sanitizeInput(bus.plate) + '</div>' +
                            '<div class="info-row"><span class="info-icon">F</span>' + sanitizeInput(bus.flight) + '</div>' +
                            '<div class="info-row"><span class="info-icon">P</span>' + sanitizeInput(bus.pax || '-') + '</div>' +
                            '<div class="info-row"><span class="info-icon">G</span>' + sanitizeInput(bus.gate || '-') + '</div>' +
                        '</div>' +
                        '<div class="countdown" style="color:' + status.color + '">⏱️ ' + countdown + '</div>';

                    spot.onmouseenter = function(e) { showTooltip(e, bus, status, i); };
                    spot.onmousemove = moveTooltip;
                    spot.onmouseleave = hideTooltip;
                } else {
                    spot.classList.add('empty');
                    spot.innerHTML = '<div class="spot-number">#' + i + '</div><div class="empty-text">—</div>';
                }

                spot.onclick = function(e) { handleSpotClick(i, bus, e); };
                container.appendChild(spot);
            }
        }

        // ═══════════════ عرض البوابات المتقدم ═══════════════
        function renderGates() {
            const container = safeGetElement('gatesGrid');
            if (!container) return;
            
            container.innerHTML = '';

            gates.forEach(function(gate) {
                var gateBuses = busData.filter(function(b) { return b.gate === gate; });
                var early = 0, ontime = 0, late = 0;
                
                gateBuses.forEach(function(bus) {
                    var status = getStatus(bus.arrival, bus.departure);
                    if (status.class === 'early') early++;
                    else if (status.class === 'ontime') ontime++;
                    else late++;
                });

                var gateSection = document.createElement('div');
                gateSection.className = 'gate-section';
                
                var busesHTML = '';
                if (gateBuses.length === 0) {
                    busesHTML = '<div style="text-align:center;color:var(--text-muted);padding:10px;font-size:0.75rem;">لا توجد حافلات</div>';
                } else {
                    gateBuses.forEach(function(bus) {
                        var status = getStatus(bus.arrival, bus.departure);
                        var countdown = getCountdownString(bus.departure);
                        busesHTML += 
                            '<div class="gate-bus-card ' + status.class + '" onclick="showFormsMenu(event, ' + bus.spot + ')">' +
                                '<div style="flex:1;">' +
                                    '<div style="font-weight:700;color:var(--primary);">' + sanitizeInput(bus.plate) + '</div>' +
                                    '<div style="font-size:0.7rem;color:var(--text-muted);">' + sanitizeInput(bus.flight) + ' | ' + sanitizeInput(bus.pax || '-') + '</div>' +
                                '</div>' +
                                '<div style="text-align:left;font-size:0.75rem;">' +
                                    '<div style="color:' + status.color + ';">' + countdown + '</div>' +
                                    '<div style="font-size:0.65rem;color:var(--text-muted);">' + sanitizeInput(status.label) + '</div>' +
                                '</div>' +
                            '</div>';
                    });
                }
                
                gateSection.innerHTML = 
                    '<div class="gate-header">' +
                        '<span class="gate-title">' + sanitizeInput(gate) + '</span>' +
                        '<div class="gate-stats-mini">' +
                            '<span class="early">' + early + '</span>' +
                            '<span class="ontime">' + ontime + '</span>' +
                            '<span class="late">' + late + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="gate-buses-list" id="gateList-' + gate + '">' + busesHTML + '</div>';
                    
                container.appendChild(gateSection);
            });
        }

        // ═══════════════ حساب الحالة ═══════════════
        function getStatus(arrival, departure) {
            var now = new Date();
            var dep = new Date(departure);
            var diff = (dep - now) / (1000 * 60 * 60);

            // ✅ إصلاح #11: التحقق من صحة التاريخ
            if (isNaN(diff) || !isFinite(diff)) {
                return { class: 'late', label: 'متأخر', color: '#f44336', hours: 0 };
            }

            if (diff > thresholds.early) {
                return { class: 'early', label: 'مبكر', color: '#4caf50', hours: diff };
            } else if (diff >= thresholds.late) {
                return { class: 'ontime', label: 'موعد', color: '#2196f3', hours: diff };
            } else {
                return { class: 'late', label: 'متأخر', color: '#f44336', hours: diff };
            }
        }

        // ═══════════════ العداد التنازلي HH:MM:SS ═══════════════
        function getCountdownString(departure) {
            if (!departure) return '--:--:--';
            
            var now = new Date();
            var dep = new Date(departure);
            var diff = dep - now;
            
            // ✅ إصلاح #12: التحقق من صحة الفرق الزمني
            if (isNaN(diff) || !isFinite(diff)) return '--:--:--';
            if (diff <= 0) return '⚠️ متأخر!';
            
            var hours = Math.floor(diff / (1000 * 60 * 60));
            var mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            var secs = Math.floor((diff % (1000 * 60)) / 1000);
            
            hours = hours < 10 ? '0' + hours : hours;
            mins = mins < 10 ? '0' + mins : mins;
            secs = secs < 10 ? '0' + secs : secs;
            return hours + ':' + mins + ':' + secs;
        }

        // ═══════════════ تحديث الإحصائيات ═══════════════
        function updateStats() {
            try {
                var early = 0, ontime = 0, late = 0, totalPax = 0;
                var flights = new Set();
                var visaCounts = { Hajj: 0, Umrah: 0, Visit: 0, Tourism: 0, GCC: 0, Work: 0 };
                var visaPaxCounts = { Hajj: 0, Umrah: 0, Visit: 0, Tourism: 0, GCC: 0, Work: 0 };

                busData.forEach(function(bus) {
                    var status = getStatus(bus.arrival, bus.departure);
                    if (status.class === 'early') early++;
                    else if (status.class === 'ontime') ontime++;
                    else late++;

                    totalPax += bus.pax || 0;
                    if (bus.flight) flights.add(bus.flight);
                    if (bus.visa && visaCounts[bus.visa] !== undefined) {
                        visaCounts[bus.visa]++;
                        visaPaxCounts[bus.visa] += bus.pax || 0;
                    }
                });

                // ✅ إصلاح #13: استخدام safeSetText بدلاً من الوصول المباشر
                safeSetText('totalBuses', busData.length);
                safeSetText('earlyBuses', early);
                safeSetText('ontimeBuses', ontime);
                safeSetText('lateBuses', late);
                safeSetText('totalPax', totalPax.toLocaleString());
                safeSetText('totalFlights', flights.size);

                safeSetText('panelOccupied', busData.length);
                safeSetText('panelEmpty', 87 - busData.length);
                safeSetText('panelEarly', early);
                safeSetText('panelOntime', ontime);
                safeSetText('panelLate', late);

                // التأشيرات - الحافلات
                safeSetText('visaHajj', visaCounts.Hajj);
                safeSetText('visaUmrah', visaCounts.Umrah);
                safeSetText('visaVisit', visaCounts.Visit);
                safeSetText('visaTourism', visaCounts.Tourism);
                safeSetText('visaGCC', visaCounts.GCC);
                safeSetText('visaWork', visaCounts.Work);

                // التأشيرات - الركاب
                safeSetText('visaPaxHajj', visaPaxCounts.Hajj.toLocaleString());
                safeSetText('visaPaxUmrah', visaPaxCounts.Umrah.toLocaleString());
                safeSetText('visaPaxVisit', visaPaxCounts.Visit.toLocaleString());
                safeSetText('visaPaxTourism', visaPaxCounts.Tourism.toLocaleString());
                safeSetText('visaPaxGCC', visaPaxCounts.GCC.toLocaleString());
                safeSetText('visaPaxWork', visaPaxCounts.Work.toLocaleString());

                // الإحصائيات اليومية
                safeSetText('dailyBuses', dailyStats.buses);
                safeSetText('dailyEarly', dailyStats.early);
                safeSetText('dailyOntime', dailyStats.ontime);
                safeSetText('dailyLate', dailyStats.late);
                safeSetText('dailyPax', dailyStats.pax.toLocaleString());
                safeSetText('dailyFlights', dailyStats.flights.size);

                renderGates();
                updateBusLists();
            } catch (error) {
                console.error('خطأ في تحديث الإحصائيات:', error);
            }
        }

        // ═══════════════ تحديث الوقت ═══════════════
        function updateTime() {
            try {
                var now = new Date();
                safeSetText('currentTime', now.toLocaleTimeString('ar-SA', { hour12: false }));
                safeSetText('currentDate', now.toLocaleDateString('ar-SA'));
                safeSetText('lastUpdate', now.toLocaleTimeString('ar-SA', { hour12: false }));

                var hour = now.getHours();
                var shift, shiftColor, shiftBg;
                
                if (hour >= 6 && hour < 14) {
                    shift = 'A';
                    shiftColor = '#4caf50';
                    shiftBg = 'rgba(76,175,80,0.2)';
                } else if (hour >= 14 && hour < 22) {
                    shift = 'B';
                    shiftColor = '#2196f3';
                    shiftBg = 'rgba(33,150,243,0.2)';
                } else {
                    shift = 'C';
                    shiftColor = '#9c27b0';
                    shiftBg = 'rgba(156,39,176,0.2)';
                }
                
                var shiftBox = safeGetElement('shiftBox');
                if (shiftBox) {
                    shiftBox.style.borderColor = shiftColor;
                    shiftBox.style.background = shiftBg;
                }
                var currentShiftEl = safeGetElement('currentShift');
                if (currentShiftEl) {
                    currentShiftEl.textContent = shift;
                    currentShiftEl.style.color = shiftColor;
                }
            } catch (error) {
                console.error('خطأ في تحديث الوقت:', error);
            }
        }

        // ═══════════════ تحديث العدادات كل ثانية ═══════════════
        function updateCountdowns() {
            try {
                busData.forEach(function(bus) {
                    if (!bus.spot) return;
                    
                    var spotEl = document.querySelector('.parking-spot[data-spot="' + bus.spot + '"]');
                    if (spotEl && !spotEl.classList.contains('empty')) {
                        var countdown = getCountdownString(bus.departure);
                        var status = getStatus(bus.arrival, bus.departure);
                        var countdownEl = spotEl.querySelector('.countdown');
                        if (countdownEl) {
                            // ✅ إصلاح #54: استخدام textContent بدلاً من innerHTML
                            countdownEl.textContent = '⏱️ ' + countdown;
                            countdownEl.style.color = status.color;
                        }
                        
                        var badgeEl = spotEl.querySelector('.spot-badge');
                        if (badgeEl) {
                            badgeEl.textContent = status.label;
                            badgeEl.className = 'spot-badge ' + status.class;
                        }
                        
                        spotEl.classList.remove('early', 'ontime', 'late');
                        spotEl.classList.add(status.class);
                    }
                });
                
                monitorStatusChanges();
            } catch (error) {
                console.error('خطأ في تحديث العدادات:', error);
            }
        }

        // ═══════════════ مراقبة تغيير الحالة التلقائي ═══════════════
        function monitorStatusChanges() {
            busData.forEach(function(bus) {
                var currentStatus = getStatus(bus.arrival, bus.departure);
                var previousStatus = bus.previousStatus || currentStatus.class;
                
                if (currentStatus.class !== previousStatus) {
                    if (previousStatus === 'early' && currentStatus.class === 'ontime') {
                        showNotification('info', 'تحديث الحالة', 'الحافلة ' + sanitizeInput(bus.plate) + ' دخلت مرحلة الموعد المحدد');
                        addAlert('info', 'تغيير حالة', 'الحافلة ' + sanitizeInput(bus.plate) + ' أصبحت في الموعد');
                    }
                    
                    if (previousStatus === 'ontime' && currentStatus.class === 'late') {
                        showNotification('warning', 'تنبيه تأخير', 'الحافلة ' + sanitizeInput(bus.plate) + ' أصبحت متأخرة');
                        addAlert('warning', 'حافلة متأخرة', 'الحافلة ' + sanitizeInput(bus.plate) + ' تجاوزت الموعد المحدد');
                    }
                    
                    if (currentStatus.class === 'late' && currentStatus.hours < 1 && bus.previousHours >= 1) {
                        showNotification('error', 'حرج', 'الحافلة ' + sanitizeInput(bus.plate) + ' متأخرة جداً');
                        addAlert('critical', 'حافلة متأخرة جداً', 'الحافلة ' + sanitizeInput(bus.plate) + ' متأخرة أقل من ساعة');
                        if (settings.sound) playAlertSound();
                    }
                    
                    bus.previousStatus = currentStatus.class;
                }
                bus.previousHours = currentStatus.hours;
            });
        }

        // ═══════════════ تشغيل صوت التنبيه ═══════════════
        // ✅ إصلاح #35: صوت تنبيه صحيح وكامل
        function playAlertSound() {
            try {
                // إنشاء صوت بيب باستخدام Web Audio API
                var AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) {
                    console.log('Web Audio API not supported');
                    return;
                }
                
                var audioCtx = new AudioContext();
                var oscillator = audioCtx.createOscillator();
                var gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = 800; // تردد الصوت (هرتز)
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3; // مستوى الصوت
                
                oscillator.start();
                
                // إيقاف الصوت بعد 200ms
                setTimeout(function() {
                    oscillator.stop();
                    audioCtx.close();
                }, 200);
                
            } catch(e) { 
                console.log('Sound not available:', e.message); 
            }
        }

        // ═══════════════ نافذة المعلومات ═══════════════
        function showTooltip(e, bus, status, spot) {
            var tooltip = safeGetElement('tooltip');
            if (!tooltip) return;
            
            tooltip.style.display = 'block';
            // ✅ إصلاح #14: تنظيف البيانات المعروضة في tooltip
            tooltip.innerHTML = 
                '<div class="tooltip-title">موقف #' + spot + '</div>' +
                '<div class="tooltip-row"><b>اللوحة:</b> ' + sanitizeInput(bus.plate) + '</div>' +
                '<div class="tooltip-row"><b>الرحلة:</b> ' + sanitizeInput(bus.flight) + '</div>' +
                '<div class="tooltip-row"><b>الركاب:</b> ' + sanitizeInput(bus.pax || '-') + '</div>' +
                '<div class="tooltip-row"><b>البوابة:</b> ' + sanitizeInput(bus.gate || '-') + '</div>' +
                '<div class="tooltip-row"><b>المغادرة:</b> ' + sanitizeInput(bus.departure) + '</div>' +
                '<div class="tooltip-row"><b>الوقت المتبقي:</b> ' + getCountdownString(bus.departure) + '</div>' +
                '<div class="tooltip-row" style="color:' + status.color + '"><b>الحالة:</b> ' + sanitizeInput(status.label) + '</div>';
            moveTooltip(e);
        }

        function moveTooltip(e) {
            var tooltip = safeGetElement('tooltip');
            if (!tooltip) return;
            tooltip.style.left = (e.pageX + 15) + 'px';
            tooltip.style.top = (e.pageY + 15) + 'px';
        }

        function hideTooltip() {
            var tooltip = safeGetElement('tooltip');
            if (tooltip) tooltip.style.display = 'none';
        }

        // ═══════════════ التعامل مع النقر ═══════════════
        // ✅ إصلاح #39: ربط handleSpotClick مع selectSpot في وضع التحرير
        function handleSpotClick(spot, bus, e) {
            if (editMode) {
                // في وضع التحرير، نستخدم selectSpot
                selectSpot(spot, bus);
            } else if (e) {
                showFormsMenu(e, spot, bus);
            } else {
                if (bus) {
                    showNotification('info', 'موقف #' + spot, 'الحافلة: ' + sanitizeInput(bus.plate));
                } else {
                    showNotification('info', 'موقف #' + spot, 'الموقف فارغ - انقر للإضافة');
                }
            }
        }

        // ═══════════════ الإشعارات ═══════════════
        function showNotification(type, title, message) {
            try {
                var container = safeGetElement('notifications');
                if (!container) return;
                
                var notification = document.createElement('div');
                notification.className = 'notification ' + type;
                notification.innerHTML = '<strong>' + sanitizeInput(title) + '</strong><br>' + sanitizeInput(message);
                container.appendChild(notification);

                setTimeout(function() { 
                    if (notification.parentNode) {
                        notification.remove(); 
                    }
                }, 5000);
            } catch (error) {
                console.error('خطأ في عرض الإشعار:', error);
            }
        }

        // ═══════════════ التحكم باللوحة ═══════════════
        function togglePanel() {
            panelVisible = !panelVisible;
            var panel = safeGetElement('controlPanel');
            var btn = safeGetElement('toggleBtn');
            if (panel) panel.classList.toggle('hidden', !panelVisible);
            if (btn) btn.classList.toggle('shifted', !panelVisible);
        }

        // ═══════════════ التبويبات ═══════════════
        // ✅ إصلاح #33: تمرير event كمعامل بدلاً من الاعتماد على global
        function showTab(tabName, e) {
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.panel-tab').forEach(function(t) { t.classList.remove('active'); });
            var tabEl = safeGetElement('tab-' + tabName);
            if (tabEl) tabEl.classList.add('active');
            // استخدام e الممرر أو window.event للتوافق
            var evt = e || window.event;
            if (evt && evt.target) evt.target.classList.add('active');
            if (tabName === 'kpis') updateKPIs();
        }

        // ═══════════════ إعدادات الحدود ═══════════════
        function updateThresholds() {
            var earlyEl = safeGetElement('earlyThreshold');
            var lateEl = safeGetElement('lateThreshold');
            thresholds.early = parseInt(earlyEl ? earlyEl.value : 7, 10) || 7;
            thresholds.late = parseInt(lateEl ? lateEl.value : 3, 10) || 3;
            updateStats();
            renderParkingGrid('entranceGrid', 1, 42);
            renderParkingGrid('exitGrid', 43, 87);
            showNotification('success', 'الإعدادات', 'تم تحديث حدود الوقت');
        }

        // ═══════════════ إعدادات الألوان ═══════════════
        function updateColors() {
            var colorPrimary = safeGetElement('colorPrimary');
            var colorEarly = safeGetElement('colorEarly');
            var colorOntime = safeGetElement('colorOntime');
            var colorLate = safeGetElement('colorLate');
            
            if (colorPrimary) document.documentElement.style.setProperty('--primary', colorPrimary.value);
            if (colorEarly) document.documentElement.style.setProperty('--green', colorEarly.value);
            if (colorOntime) document.documentElement.style.setProperty('--blue', colorOntime.value);
            if (colorLate) document.documentElement.style.setProperty('--red', colorLate.value);
        }

        // ═══════════════ تبديل الإعدادات ═══════════════
        var settings = { sound: false, notif: true, autoRefresh: true };

        function toggleSetting(setting) {
            settings[setting] = !settings[setting];
            var toggle = safeGetElement(setting + 'Toggle');
            if (toggle) toggle.classList.toggle('active', settings[setting]);
            showNotification('info', 'الإعدادات', setting + ': ' + (settings[setting] ? 'مفعل' : 'معطل'));
        }

        // ═══════════════ حجم المواقف ═══════════════
        function updateSpotSize() {
            var spotSizeEl = safeGetElement('spotSize');
            var size = spotSizeEl ? spotSizeEl.value : 80;
            document.querySelectorAll('.parking-spot').forEach(function(spot) {
                spot.style.minHeight = size + 'px';
            });
        }

        // ═══════════════ حفظ وتحميل الإعدادات ═══════════════
        function saveSettings() {
            try {
                var settingsData = {
                    thresholds: thresholds,
                    settings: settings,
                    colors: {
                        primary: safeGetElement('colorPrimary') ? safeGetElement('colorPrimary').value : '#ffd700',
                        early: safeGetElement('colorEarly') ? safeGetElement('colorEarly').value : '#4caf50',
                        ontime: safeGetElement('colorOntime') ? safeGetElement('colorOntime').value : '#2196f3',
                        late: safeGetElement('colorLate') ? safeGetElement('colorLate').value : '#f44336'
                    },
                    spotSize: safeGetElement('spotSize') ? safeGetElement('spotSize').value : 80
                };
                // ✅ إصلاح #15: استخدام safeJSONStringify
                localStorage.setItem('LOCC_Settings', safeJSONStringify(settingsData));
                showNotification('success', 'الإعدادات', 'تم حفظ الإعدادات بنجاح');
            } catch (error) {
                console.error('خطأ في حفظ الإعدادات:', error);
                showNotification('error', 'خطأ', 'فشل في حفظ الإعدادات');
            }
        }

        function loadSettings() {
            try {
                var saved = localStorage.getItem('LOCC_Settings');
                // ✅ إصلاح #16: استخدام safeJSONParse
                var data = safeJSONParse(saved, null);
                if (data) {
                    if (data.thresholds) {
                        thresholds = data.thresholds;
                        var earlyEl = safeGetElement('earlyThreshold');
                        var lateEl = safeGetElement('lateThreshold');
                        if (earlyEl) earlyEl.value = thresholds.early;
                        if (lateEl) lateEl.value = thresholds.late;
                    }
                    if (data.settings) {
                        settings = data.settings;
                        var soundToggle = safeGetElement('soundToggle');
                        var notifToggle = safeGetElement('notifToggle');
                        var autoRefreshToggle = safeGetElement('autoRefreshToggle');
                        if (soundToggle) soundToggle.classList.toggle('active', settings.sound);
                        if (notifToggle) notifToggle.classList.toggle('active', settings.notif);
                        if (autoRefreshToggle) autoRefreshToggle.classList.toggle('active', settings.autoRefresh);
                    }
                    if (data.colors) {
                        var colorPrimary = safeGetElement('colorPrimary');
                        var colorEarly = safeGetElement('colorEarly');
                        var colorOntime = safeGetElement('colorOntime');
                        var colorLate = safeGetElement('colorLate');
                        if (colorPrimary) colorPrimary.value = data.colors.primary;
                        if (colorEarly) colorEarly.value = data.colors.early;
                        if (colorOntime) colorOntime.value = data.colors.ontime;
                        if (colorLate) colorLate.value = data.colors.late;
                        updateColors();
                    }
                    if (data.spotSize) {
                        var spotSizeEl = safeGetElement('spotSize');
                        if (spotSizeEl) spotSizeEl.value = data.spotSize;
                        updateSpotSize();
                    }
                    showNotification('success', 'الإعدادات', 'تم تحميل الإعدادات');
                }
            } catch (error) {
                console.error('خطأ في تحميل الإعدادات:', error);
            }
        }

        function resetSettings() {
            if (confirm('هل تريد إعادة تعيين جميع الإعدادات؟')) {
                localStorage.removeItem('LOCC_Settings');
                location.reload();
            }
        }

        // ═══════════════ التنبيهات ═══════════════
        var alertsList = [];

        function addAlert(type, title, message) {
            var alert = {
                id: Date.now(),
                type: type,
                title: sanitizeInput(title),
                message: sanitizeInput(message),
                time: new Date().toLocaleTimeString('ar-SA', { hour12: false })
            };
            alertsList.unshift(alert);
            if (alertsList.length > 50) alertsList.pop();
            renderAlerts();
            if (settings.notif) showNotification(type, title, message);
        }

        function renderAlerts() {
            var container = safeGetElement('alertsList');
            if (!container) return;
            
            safeSetText('alertsCount', alertsList.length);
            
            if (alertsList.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">لا توجد تنبيهات</div>';
                return;
            }
            
            var html = '';
            alertsList.forEach(function(a) {
                html += '<div class="alert-item ' + a.type + '">' +
                    '<div class="alert-header">' +
                        '<span class="alert-title">' + a.title + '</span>' +
                        '<span class="alert-time">' + a.time + '</span>' +
                    '</div>' +
                    '<div>' + a.message + '</div>' +
                '</div>';
            });
            container.innerHTML = html;
        }

        function clearAlerts() {
            alertsList = [];
            renderAlerts();
            showNotification('info', 'التنبيهات', 'تم مسح جميع التنبيهات');
        }

        function testAlert() {
            var types = ['critical', 'warning', 'info', 'success'];
            var type = types[Math.floor(Math.random() * types.length)];
            addAlert(type, 'تنبيه تجريبي', 'هذا تنبيه تجريبي للاختبار');
        }

        // ═══════════════ مؤشرات الأداء ═══════════════
        var peakOccupancy = 0;

        function updateKPIs() {
            try {
                var total = busData.length;
                var occupancy = Math.round((total / 87) * 100);
                if (occupancy > peakOccupancy) peakOccupancy = occupancy;

                var early = 0, ontime = 0, late = 0, totalPax = 0;
                busData.forEach(function(bus) {
                    var status = getStatus(bus.arrival, bus.departure);
                    if (status.class === 'early') early++;
                    else if (status.class === 'ontime') ontime++;
                    else late++;
                    totalPax += bus.pax || 0;
                });

                var onTimeRate = total > 0 ? Math.round(((early + ontime) / total) * 100) : 0;
                var avgPax = total > 0 ? Math.round(totalPax / total) : 0;
                var avgWait = Math.round(Math.random() * 30 + 10);

                safeSetText('kpiOccupancy', occupancy + '%');
                var occupancyBar = safeGetElement('occupancyBar');
                if (occupancyBar) occupancyBar.style.width = occupancy + '%';
                
                safeSetText('kpiAvgWait', avgWait);
                safeSetText('kpiOnTimeRate', onTimeRate + '%');
                
                var onTimeBar = safeGetElement('onTimeBar');
                if (onTimeBar) {
                    onTimeBar.style.width = onTimeRate + '%';
                    onTimeBar.style.background = onTimeRate >= 80 ? 'var(--green)' : onTimeRate >= 50 ? 'var(--orange)' : 'var(--red)';
                }
                
                safeSetText('kpiAvgPax', avgPax);
                safeSetText('kpiPeakOccupancy', peakOccupancy + '%');
                safeSetText('kpiBusesToday', dailyStats.buses);
                safeSetText('kpiPaxToday', dailyStats.pax.toLocaleString());

                // تحديث الرسم البياني
                var totalStatus = early + ontime + late || 1;
                var barEarly = safeGetElement('barEarly');
                var barOntime = safeGetElement('barOntime');
                var barLate = safeGetElement('barLate');
                if (barEarly) barEarly.style.height = Math.max((early / totalStatus) * 100, 5) + '%';
                if (barOntime) barOntime.style.height = Math.max((ontime / totalStatus) * 100, 5) + '%';
                if (barLate) barLate.style.height = Math.max((late / totalStatus) * 100, 5) + '%';
            } catch (error) {
                console.error('خطأ في تحديث مؤشرات الأداء:', error);
            }
        }

        // ═══════════════ إضافة حافلة جديدة ═══════════════
        var selectedSpot = null;

        function addNewBus() {
            var spotNumEl = safeGetElement('newSpotNumber');
            var spotNum = parseInt(spotNumEl ? spotNumEl.value : 0, 10);
            
            // ✅ إصلاح #17: استخدام validateSpotNumber
            if (!validateSpotNumber(spotNum)) {
                showNotification('error', 'خطأ', 'أدخل رقم موقف صحيح (1-87)');
                return;
            }
            if (busData.find(function(b) { return b.spot === spotNum; })) {
                showNotification('error', 'خطأ', 'الموقف مشغول بالفعل');
                return;
            }
            openForm('ScrSegregationIn', spotNum);
        }

        function selectSpot(spotNum, bus) {
            selectedSpot = { num: spotNum, bus: bus };
            var spotActions = safeGetElement('spotActions');
            if (spotActions) spotActions.style.display = 'block';
            safeSetText('selectedSpotNum', spotNum);
        }

        function editSpot() {
            if (selectedSpot && selectedSpot.bus) {
                openForm('ScrSegregationIn', selectedSpot.num);
            }
        }

        // ✅ إصلاح #40: استبدال prompt بـ modal آمن
        function moveSpot() {
            if (selectedSpot && selectedSpot.bus) {
                // إنشاء modal للإدخال بدلاً من prompt
                showMoveSpotModal(selectedSpot);
            } else {
                showNotification('error', 'خطأ', 'لم يتم تحديد موقف');
            }
        }
        
        function showMoveSpotModal(spotData) {
            var modalHTML = 
                '<div class="form-group">' +
                    '<label class="form-label required">رقم الموقف الجديد (1-87)</label>' +
                    '<input type="number" class="form-input" id="newSpotInput" min="1" max="87" placeholder="أدخل رقم الموقف">' +
                '</div>' +
                '<div style="color:var(--text-muted);font-size:0.8rem;margin-top:10px;">' +
                    'الموقف الحالي: ' + spotData.num +
                '</div>';
            
            var modal = safeGetElement('modalOverlay');
            var title = safeGetElement('modalTitle');
            var body = safeGetElement('modalBody');
            var footer = modal.querySelector('.modal-footer');
            
            if (title) title.textContent = 'نقل الحافلة إلى موقف جديد';
            if (body) body.innerHTML = modalHTML;
            
            // تغيير أزرار الـ footer
            if (footer) {
                footer.innerHTML = 
                    '<button class="panel-btn primary" onclick="confirmMoveSpot()" style="flex:1;">✓ نقل</button>' +
                    '<button class="panel-btn danger" onclick="closeModal()" style="flex:1;">إلغاء</button>';
            }
            
            if (modal) modal.classList.add('active');
            
            // التركيز على حقل الإدخال
            setTimeout(function() {
                var input = safeGetElement('newSpotInput');
                if (input) input.focus();
            }, 100);
        }
        
        function confirmMoveSpot() {
            var input = safeGetElement('newSpotInput');
            if (!input) return;
            
            var newSpotNum = parseInt(input.value, 10);
            
            // ✅ التحقق من صحة الموقف الجديد
            if (!validateSpotNumber(newSpotNum)) {
                showNotification('error', 'خطأ', 'رقم الموقف يجب أن يكون بين 1 و 87');
                return;
            }
            
            if (busData.find(function(b) { return b.spot === newSpotNum; })) {
                showNotification('error', 'خطأ', 'الموقف ' + newSpotNum + ' مشغول بالفعل');
                return;
            }
            
            if (selectedSpot && selectedSpot.bus) {
                selectedSpot.bus.spot = newSpotNum;
                updateStats();
                renderParkingGrid('entranceGrid', 1, 42);
                renderParkingGrid('exitGrid', 43, 87);
                closeModal();
                showNotification('success', 'نقل', 'تم نقل الحافلة إلى الموقف ' + newSpotNum);
                
                // إعادة تعيين الموقف المحدد
                var spotActionsEl = safeGetElement('spotActions');
                if (spotActionsEl) spotActionsEl.style.display = 'none';
                selectedSpot = null;
            }
        }

        function deleteSpot() {
            if (selectedSpot && selectedSpot.bus) {
                if (confirm('هل تريد حذف هذه الحافلة؟')) {
                    busData = busData.filter(function(b) { return b.spot !== selectedSpot.num; });
                    updateStats();
                    renderParkingGrid('entranceGrid', 1, 42);
                    renderParkingGrid('exitGrid', 43, 87);
                    var spotActions = safeGetElement('spotActions');
                    if (spotActions) spotActions.style.display = 'none';
                    showNotification('warning', 'حذف', 'تم حذف الحافلة');
                }
            }
        }

        // ═══════════════ النماذج ═══════════════
        function openForm(formName, spotNum) {
            spotNum = spotNum || null;
            showNotification('info', 'النماذج', 'فتح نموذج: ' + sanitizeInput(formName) + (spotNum ? ' - موقف ' + spotNum : ''));
            currentFormName = formName;
            currentSpotForForm = spotNum;
            openFormModal(formName);
        }

        // ═══════════════ قائمة النماذج ═══════════════
        // ✅ إصلاح #32: حل Race Condition في Event Listeners
        var formsMenuClickHandler = null;
        
        function showFormsMenu(e, spotNum, bus) {
            bus = bus || null;
            e.stopPropagation();
            var menu = safeGetElement('formsMenu');
            if (!menu) return;
            
            // إزالة أي listener سابق لمنع التراكم
            if (formsMenuClickHandler) {
                document.removeEventListener('click', formsMenuClickHandler);
                formsMenuClickHandler = null;
            }
            
            currentSpotForForm = spotNum;
            currentBusForForm = bus;
            
            updateFormStatusInMenu(bus);
            
            var x = e.pageX;
            var y = e.pageY;
            if (x + 230 > window.innerWidth) x = window.innerWidth - 240;
            if (y + 300 > window.innerHeight) y = window.innerHeight - 310;
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('active');
            
            // إنشاء handler جديد وحفظه
            formsMenuClickHandler = function(clickEvent) {
                // التحقق من أن النقر خارج القائمة
                if (!menu.contains(clickEvent.target)) {
                    closeFormsMenu();
                }
            };
            
            // تأخير بسيط ثم إضافة listener
            setTimeout(function() {
                document.addEventListener('click', formsMenuClickHandler);
            }, 50);
        }

        function closeFormsMenu() {
            var menu = safeGetElement('formsMenu');
            if (menu) menu.classList.remove('active');
            
            // إزالة الـ listener عند الإغلاق
            if (formsMenuClickHandler) {
                document.removeEventListener('click', formsMenuClickHandler);
                formsMenuClickHandler = null;
            }
        }

        function updateFormStatusInMenu(bus) {
            var forms = ['ScrLogIn', 'ScrSegregationIn', 'ScrWelcomeLounge', 'ScrSegregationExit', 'ScrCurbside'];
            forms.forEach(function(form, i) {
                var statusEl = safeGetElement('formStatus' + (i + 1));
                if (statusEl) {
                    if (bus && bus.forms && bus.forms[form]) {
                        statusEl.textContent = 'OK';
                    } else {
                        statusEl.textContent = '⬜';
                    }
                }
            });
        }

        function selectFormFromMenu(formName) {
            closeFormsMenu();
            currentFormName = formName;
            openFormModal(formName, currentBusForForm);
        }

        // ═══════════════ النوافذ المنبثقة ═══════════════
        function openFormModal(formName, bus) {
            bus = bus || null;
            var modal = safeGetElement('modalOverlay');
            var title = safeGetElement('modalTitle');
            var body = safeGetElement('modalBody');
            if (!modal || !title || !body) return;
            
            var formTitles = {
                'ScrLogIn': 'تسجيل الدخول',
                'ScrSegregationIn': 'دخول الحافلات للفصل',
                'ScrWelcomeLounge': 'صالة الترحيب',
                'ScrSegregationExit': 'خروج الحافلات من الفصل',
                'ScrCurbside': 'الرصيف'
            };
            
            title.textContent = formTitles[formName] || formName;
            body.innerHTML = getFormHTML(formName, bus);
            modal.classList.add('active');
        }

        function getFormHTML(formName, bus) {
            bus = bus || null;
            var data = (bus && bus.forms && bus.forms[formName]) ? bus.forms[formName] : {};
            
            // تعبئة البيانات من الحافلة إذا لم تكن موجودة في النموذج
            if (bus) {
                data.BusPlate = data.BusPlate || bus.plate || '';
                data.BusNO = data.BusNO || bus.busNo || '';
                data.FlightNo = data.FlightNo || bus.flight || '';
                data.PaxCount = data.PaxCount || bus.pax || '';
                data.GetaNO = data.GetaNO || bus.gate || '';
                data.ParkNO = data.ParkNO || bus.spot || '';
            }
            
            // ✅ إصلاح #19: تنظيف جميع البيانات المعروضة في النماذج
            var safeData = {};
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    safeData[key] = sanitizeInput(data[key]);
                }
            }
            
            var forms = {
                'ScrLogIn': getFormScrLogIn(safeData),
                'ScrSegregationIn': getFormScrSegregationIn(safeData),
                'ScrWelcomeLounge': getFormScrWelcomeLounge(safeData, bus),
                'ScrSegregationExit': getFormScrSegregationExit(safeData, bus),
                'ScrCurbside': getFormScrCurbside(safeData, bus)
            };
            
            return forms[formName] || '<p>النموذج غير متوفر</p>';
        }
        
        function getFormScrLogIn(data) {
            return '<div class="form-group">' +
                '<label class="form-label required">موقع العمل</label>' +
                '<select class="form-select" id="cmbWorkLoc">' +
                    '<option value="">اختر...</option>' +
                    '<option value="ScrLogIn"' + (data.cmbWorkLoc === 'ScrLogIn' ? ' selected' : '') + '>ScrLogIn</option>' +
                    '<option value="ScrSegregationIn"' + (data.cmbWorkLoc === 'ScrSegregationIn' ? ' selected' : '') + '>ScrSegregationIn</option>' +
                    '<option value="ScrWelcomeLounge"' + (data.cmbWorkLoc === 'ScrWelcomeLounge' ? ' selected' : '') + '>ScrWelcomeLounge</option>' +
                    '<option value="ScrSegregationExit"' + (data.cmbWorkLoc === 'ScrSegregationExit' ? ' selected' : '') + '>ScrSegregationExit</option>' +
                    '<option value="ScrCurbside"' + (data.cmbWorkLoc === 'ScrCurbside' ? ' selected' : '') + '>ScrCurbside</option>' +
                '</select>' +
            '</div>';
        }
        
        function getFormScrSegregationIn(data) {
            return '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusPlate</label>' +
                    '<input type="text" class="form-input" id="BusPlate" value="' + (data.BusPlate || '') + '">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusNO</label>' +
                    '<input type="number" class="form-input" id="BusNO" value="' + (data.BusNO || '') + '">' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label">TripCount</label>' +
                    '<input type="number" class="form-input" id="TripCount" value="' + (data.TripCount || '') + '">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">DepTime</label>' +
                    '<input type="datetime-local" class="form-input" id="DepTime" value="' + (data.DepTime || '') + '" step="1">' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">FlightNo</label>' +
                    '<input type="text" class="form-input" id="FlightNo" value="' + (data.FlightNo || '') + '">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">CurDT</label>' +
                    '<input type="datetime-local" class="form-input" id="CurDT" value="' + (data.CurDT || new Date().toISOString().slice(0,16)) + '" step="1">' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">TerminalCd</label>' +
                    '<select class="form-select" id="TerminalCd">' +
                        '<option value="">اختر...</option>' +
                        '<option value="HT"' + (data.TerminalCd === 'HT' ? ' selected' : '') + '>HT</option>' +
                        '<option value="NT"' + (data.TerminalCd === 'NT' ? ' selected' : '') + '>NT</option>' +
                        '<option value="T1"' + (data.TerminalCd === 'T1' ? ' selected' : '') + '>T1</option>' +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">TotalPax</label>' +
                    '<input type="text" class="form-input" id="TotalPax" value="' + (data.TotalPax || '') + '">' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">PaxCount</label>' +
                    '<input type="number" class="form-input" id="PaxCount" value="' + (data.PaxCount || '') + '">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">Destination</label>' +
                    '<input type="text" class="form-input" id="Destination" value="' + (data.Destination || '') + '">' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label">DispatchSts</label>' +
                    '<select class="form-select" id="DispatchSts">' +
                        '<option value="">اختر...</option>' +
                        '<option value="خاطئ"' + (data.DispatchSts === 'خاطئ' ? ' selected' : '') + '>خاطئ</option>' +
                        '<option value="مبكر"' + (data.DispatchSts === 'مبكر' ? ' selected' : '') + '>مبكر</option>' +
                        '<option value="متأخر"' + (data.DispatchSts === 'متأخر' ? ' selected' : '') + '>متأخر</option>' +
                        '<option value="مشترك رحلات"' + (data.DispatchSts === 'مشترك رحلات' ? ' selected' : '') + '>مشترك رحلات</option>' +
                        '<option value="مشترك رحلات وصالات"' + (data.DispatchSts === 'مشترك رحلات وصالات' ? ' selected' : '') + '>مشترك رحلات وصالات</option>' +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">VisaType</label>' +
                    '<select class="form-select" id="VisaType">' +
                        '<option value="">اختر...</option>' +
                        '<option value="Hajj"' + (data.VisaType === 'Hajj' ? ' selected' : '') + '>Hajj</option>' +
                        '<option value="GCC"' + (data.VisaType === 'GCC' ? ' selected' : '') + '>GCC</option>' +
                        '<option value="Visit"' + (data.VisaType === 'Visit' ? ' selected' : '') + '>Visit</option>' +
                        '<option value="Tourism"' + (data.VisaType === 'Tourism' ? ' selected' : '') + '>Tourism</option>' +
                        '<option value="Work"' + (data.VisaType === 'Work' ? ' selected' : '') + '>Work</option>' +
                        '<option value="Umrah"' + (data.VisaType === 'Umrah' ? ' selected' : '') + '>Umrah</option>' +
                    '</select>' +
                '</div>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">UmrahCop</label>' +
                '<input type="text" class="form-input" id="UmrahCop" value="' + (data.UmrahCop || '') + '">' +
            '</div>';
        }
        
        function getFormScrWelcomeLounge(data, bus) {
            return '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusNO</label>' +
                    '<input type="number" class="form-input" id="BusNO" value="' + ((bus && bus.busNo) || data.BusNO || '') + '" readonly style="background:#333;">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">ParkNO</label>' +
                    '<input type="number" class="form-input" id="ParkNO" value="' + (currentSpotForForm || data.ParkNO || '') + '" min="1" max="87" placeholder="1-87">' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusPlate</label>' +
                    '<input type="text" class="form-input" id="BusPlate" value="' + ((bus && bus.plate) || data.BusPlate || '') + '" readonly style="background:#333;">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">BagStatus</label>' +
                    '<select class="form-select" id="BagStatus">' +
                        '<option value="">اختر...</option>' +
                        '<option value="دينة"' + (data.BagStatus === 'دينة' ? ' selected' : '') + '>دينة</option>' +
                        '<option value="لا يوجد"' + (data.BagStatus === 'لا يوجد' ? ' selected' : '') + '>لا يوجد</option>' +
                        '<option value="مختلط"' + (data.BagStatus === 'مختلط' ? ' selected' : '') + '>مختلط</option>' +
                    '</select>' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label">T3CALL</label>' +
                    '<input type="datetime-local" class="form-input" id="T3CALL" value="' + (data.T3CALL || '') + '" step="1">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">FlightSts</label>' +
                    '<select class="form-select" id="FlightSts">' +
                        '<option value="">اختر...</option>' +
                        '<option value="أقلعت"' + (data.FlightSts === 'أقلعت' ? ' selected' : '') + '>أقلعت</option>' +
                        '<option value="أُلغيت"' + (data.FlightSts === 'أُلغيت' ? ' selected' : '') + '>أُلغيت</option>' +
                        '<option value="متأخرة"' + (data.FlightSts === 'متأخرة' ? ' selected' : '') + '>متأخرة</option>' +
                        '<option value="في الموعد"' + (data.FlightSts === 'في الموعد' ? ' selected' : '') + '>في الموعد</option>' +
                    '</select>' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label">T3ACT</label>' +
                    '<select class="form-select" id="T3ACT">' +
                        '<option value="">اختر...</option>' +
                        '<option value="Approval"' + (data.T3ACT === 'Approval' ? ' selected' : '') + '>Approval</option>' +
                        '<option value="Waiting"' + (data.T3ACT === 'Waiting' ? ' selected' : '') + '>Waiting</option>' +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">GetaNO</label>' +
                    '<select class="form-select" id="GetaNO">' +
                        '<option value="">اختر...</option>' +
                        '<option value="A1"' + (data.GetaNO === 'A1' ? ' selected' : '') + '>A1</option>' +
                        '<option value="A2"' + (data.GetaNO === 'A2' ? ' selected' : '') + '>A2</option>' +
                        '<option value="B1"' + (data.GetaNO === 'B1' ? ' selected' : '') + '>B1</option>' +
                        '<option value="B2"' + (data.GetaNO === 'B2' ? ' selected' : '') + '>B2</option>' +
                        '<option value="C1"' + (data.GetaNO === 'C1' ? ' selected' : '') + '>C1</option>' +
                        '<option value="C2"' + (data.GetaNO === 'C2' ? ' selected' : '') + '>C2</option>' +
                        '<option value="D1"' + (data.GetaNO === 'D1' ? ' selected' : '') + '>D1</option>' +
                        '<option value="D2"' + (data.GetaNO === 'D2' ? ' selected' : '') + '>D2</option>' +
                        '<option value="E1"' + (data.GetaNO === 'E1' ? ' selected' : '') + '>E1</option>' +
                        '<option value="E2"' + (data.GetaNO === 'E2' ? ' selected' : '') + '>E2</option>' +
                    '</select>' +
                '</div>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">T3APRO</label>' +
                '<input type="datetime-local" class="form-input" id="T3APRO" value="' + (data.T3APRO || '') + '" step="1">' +
            '</div>';
        }
        
        function getFormScrSegregationExit(data, bus) {
            return '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">FlightNo</label>' +
                    '<input type="text" class="form-input" id="FlightNo" value="' + ((bus && bus.flight) || data.FlightNo || '') + '">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusPlate</label>' +
                    '<input type="text" class="form-input" id="BusPlate" value="' + ((bus && bus.plate) || data.BusPlate || '') + '">' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusNO</label>' +
                    '<input type="number" class="form-input" id="BusNO" value="' + (data.BusNO || '') + '">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">ExitDT</label>' +
                    '<input type="datetime-local" class="form-input" id="ExitDT" value="' + (data.ExitDT || new Date().toISOString().slice(0,16)) + '" step="1">' +
                '</div>' +
            '</div>' +
            '<div style="background:rgba(255,152,0,0.2);padding:10px;border-radius:6px;margin-top:10px;">' +
                '<span style="color:var(--orange);">⚠️ تحذير:</span> عند الحفظ سيتم إخلاء الموقف ونقل الحافلة لقسم البوابات' +
            '</div>';
        }
        
        function getFormScrCurbside(data, bus) {
            var gateValue = (bus && bus.gate) || data.GetaNO || '';
            return '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusNO</label>' +
                    '<input type="number" class="form-input" id="BusNO" value="' + (data.BusNO || '') + '">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusDepDT</label>' +
                    '<input type="datetime-local" class="form-input" id="BusDepDT" value="' + (data.BusDepDT || new Date().toISOString().slice(0,16)) + '" step="1">' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label">PaxDisembarkDT</label>' +
                    '<input type="datetime-local" class="form-input" id="PaxDisembarkDT" value="' + (data.PaxDisembarkDT || '') + '" step="1">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusArrDT</label>' +
                    '<input type="datetime-local" class="form-input" id="BusArrDT" value="' + (data.BusArrDT || '') + '" step="1">' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label required">BusPlate</label>' +
                    '<input type="text" class="form-input" id="BusPlate" value="' + ((bus && bus.plate) || data.BusPlate || '') + '">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label">DelayReason</label>' +
                    '<select class="form-select" id="DelayReason">' +
                        '<option value="">اختر...</option>' +
                        '<option value="ZMZM"' + (data.DelayReason === 'ZMZM' ? ' selected' : '') + '>ZMZM</option>' +
                        '<option value="Operations"' + (data.DelayReason === 'Operations' ? ' selected' : '') + '>Operations</option>' +
                        '<option value="Bags"' + (data.DelayReason === 'Bags' ? ' selected' : '') + '>Bags</option>' +
                        '<option value="Passport Distribution"' + (data.DelayReason === 'Passport Distribution' ? ' selected' : '') + '>Passport Distribution</option>' +
                    '</select>' +
                '</div>' +
            '</div>' +
            '<div class="form-row">' +
                '<div class="form-group">' +
                    '<label class="form-label">FlightSts</label>' +
                    '<select class="form-select" id="FlightSts">' +
                        '<option value="">اختر...</option>' +
                        '<option value="أقلعت"' + (data.FlightSts === 'أقلعت' ? ' selected' : '') + '>أقلعت</option>' +
                        '<option value="أُلغيت"' + (data.FlightSts === 'أُلغيت' ? ' selected' : '') + '>أُلغيت</option>' +
                        '<option value="متأخرة"' + (data.FlightSts === 'متأخرة' ? ' selected' : '') + '>متأخرة</option>' +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label class="form-label required">GetaNO</label>' +
                    '<select class="form-select" id="GetaNO">' +
                        '<option value="">اختر...</option>' +
                        '<option value="A1"' + (gateValue === 'A1' ? ' selected' : '') + '>A1</option>' +
                        '<option value="A2"' + (gateValue === 'A2' ? ' selected' : '') + '>A2</option>' +
                        '<option value="B1"' + (gateValue === 'B1' ? ' selected' : '') + '>B1</option>' +
                        '<option value="B2"' + (gateValue === 'B2' ? ' selected' : '') + '>B2</option>' +
                        '<option value="C1"' + (gateValue === 'C1' ? ' selected' : '') + '>C1</option>' +
                        '<option value="C2"' + (gateValue === 'C2' ? ' selected' : '') + '>C2</option>' +
                        '<option value="D1"' + (gateValue === 'D1' ? ' selected' : '') + '>D1</option>' +
                        '<option value="D2"' + (gateValue === 'D2' ? ' selected' : '') + '>D2</option>' +
                        '<option value="E1"' + (gateValue === 'E1' ? ' selected' : '') + '>E1</option>' +
                        '<option value="E2"' + (gateValue === 'E2' ? ' selected' : '') + '>E2</option>' +
                    '</select>' +
                '</div>' +
            '</div>' +
            '<div style="background:rgba(244,67,54,0.2);padding:10px;border-radius:6px;margin-top:10px;">' +
                '<span style="color:var(--red);">⚠️ تحذير:</span> عند الحفظ سيتم إخفاء الحافلة من البوابات ونقلها لسجل الحافلات المغادرة' +
            '</div>';
        }

        function closeModal() {
            var modal = safeGetElement('modalOverlay');
            if (modal) modal.classList.remove('active');
            currentFormName = null;
            currentSpotForForm = null;
            currentBusForForm = null;
        }

        function closeModalOnOverlay(e) {
            if (e.target.id === 'modalOverlay') closeModal();
        }

        function saveFormData() {
            try {
                // جمع البيانات من النموذج
                var formData = {};
                var inputs = document.querySelectorAll('#modalBody input, #modalBody select');
                inputs.forEach(function(input) {
                    formData[input.id] = input.value;
                });
                formData.timestamp = new Date().toISOString();
                
                // معالجة حسب نوع النموذج
                if (currentFormName === 'ScrSegregationIn') {
                    // ✅ إصلاح #20: التحقق من صحة بيانات الحافلة الجديدة
                    if (!formData.BusPlate || formData.BusPlate.trim() === '') {
                        showNotification('error', 'خطأ', 'يرجى إدخال رقم لوحة الحافلة');
                        return;
                    }
                    
                    var newBus = {
                        id: Date.now(),
                        plate: formData.BusPlate.trim(),
                        busNo: formData.BusNO,
                        flight: formData.FlightNo,
                        pax: parseInt(formData.PaxCount, 10) || 0,
                        visa: formData.VisaType,
                        terminal: formData.TerminalCd,
                        destination: formData.Destination,
                        departure: formData.DepTime,
                        arrival: new Date().toISOString(),
                        tripCount: formData.TripCount,
                        totalPax: formData.TotalPax,
                        dispatchSts: formData.DispatchSts,
                        umrahCop: formData.UmrahCop,
                        curDT: formData.CurDT,
                        spot: null,
                        gate: null,
                        forms: { ScrSegregationIn: formData }
                    };
                    busData.push(newBus);
                    
                    dailyStats.buses++;
                    dailyStats.pax += newBus.pax;
                    dailyStats.flights.add(newBus.flight);
                    
                    var status = getStatus(newBus.arrival, newBus.departure);
                    if (status.class === 'early') dailyStats.early++;
                    else if (status.class === 'ontime') dailyStats.ontime++;
                    else if (status.class === 'late') dailyStats.late++;
                    
                    showNotification('success', 'ScrSegregationIn', 'تم تسجيل الحافلة ' + sanitizeInput(formData.BusPlate) + ' - اضغط عليها في قائمة "مسجلة" لتحديد الموقف');
                    
                } else if (currentFormName === 'ScrWelcomeLounge') {
                    var spotNum = parseInt(formData.ParkNO, 10);
                    
                    // ✅ إصلاح #21: التحقق من صحة رقم الموقف
                    if (!validateSpotNumber(spotNum)) {
                        showNotification('error', 'خطأ', 'يرجى تحديد رقم موقف صحيح (1-87)');
                        return;
                    }
                    
                    var existingBus = busData.find(function(b) { return b.spot === spotNum; });
                    if (existingBus && currentBusForForm && existingBus.id !== currentBusForForm.id) {
                        showNotification('error', 'خطأ', 'الموقف ' + spotNum + ' مشغول بالفعل');
                        return;
                    }
                    
                    if (currentBusForForm) {
                        var busIndex = busData.findIndex(function(b) { return b.id === currentBusForForm.id; });
                        if (busIndex !== -1) {
                            busData[busIndex].spot = spotNum;
                            busData[busIndex].gate = formData.GetaNO;
                            busData[busIndex].bagStatus = formData.BagStatus;
                            busData[busIndex].flightSts = formData.FlightSts;
                            busData[busIndex].t3call = formData.T3CALL;
                            busData[busIndex].t3act = formData.T3ACT;
                            busData[busIndex].t3apro = formData.T3APRO;
                            busData[busIndex].forms.ScrWelcomeLounge = formData;
                        }
                    }
                    
                    showNotification('success', 'ScrWelcomeLounge', 'تم تحديد الموقف ' + spotNum + ' للحافلة');
                    
                } else if (currentFormName === 'ScrSegregationExit') {
                    if (currentBusForForm) {
                        var busIndex = busData.findIndex(function(b) { return b.id === currentBusForForm.id; });
                        if (busIndex !== -1) {
                            var bus = busData[busIndex];
                            bus.exitDT = formData.ExitDT;
                            if (!bus.forms) { bus.forms = {}; }
                            bus.forms.ScrSegregationExit = formData;
                            bus.spot = null;
                        }
                    }
                    showNotification('success', 'ScrSegregationExit', 'تم إخلاء الموقف');
                    
                } else if (currentFormName === 'ScrCurbside') {
                    if (currentBusForForm) {
                        var busIndex = busData.findIndex(function(b) { return b.id === currentBusForForm.id; });
                        if (busIndex !== -1) {
                            var bus = busData.splice(busIndex, 1)[0];
                            bus.busDepDT = formData.BusDepDT;
                            bus.busArrDT = formData.BusArrDT;
                            bus.paxDisembarkDT = formData.PaxDisembarkDT;
                            bus.delayReason = formData.DelayReason;
                            if (!bus.forms) { bus.forms = {}; }
                            bus.forms.ScrCurbside = formData;
                            departedBuses.unshift(bus);
                        }
                    }
                    showNotification('success', 'ScrCurbside', 'تم تسجيل مغادرة الحافلة');
                }
                
                closeModal();
                saveData();
                updateStats();
                renderParkingGrid('entranceGrid', 1, 42);
                renderParkingGrid('exitGrid', 43, 87);
                renderGates();
                updateBusLists();
                updateKPIs();
            } catch (error) {
                console.error('خطأ في حفظ بيانات النموذج:', error);
                showNotification('error', 'خطأ', 'فشل في حفظ البيانات');
            }
        }

        // ═══════════════ تحديث قوائم الحافلات ═══════════════
        function updateBusLists() {
            updateRegisteredList();
            updateSegregationList();
            updateDepartedList();
        }

        function updateRegisteredList() {
            var list = safeGetElement('registeredList');
            if (!list) return;
            
            safeSetText('registeredCount', busData.length);
            
            if (busData.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">لا توجد حافلات مسجلة</div>';
                return;
            }
            
            var html = '';
            busData.forEach(function(bus) {
                var status = getStatus(bus.arrival, bus.departure);
                var formsCompleted = bus.forms ? Object.keys(bus.forms).length : 1;
                // ✅ إصلاح #22: استخدام data attribute بدلاً من inline JSON
                html += '<div class="bus-card ' + status.class + '" data-bus-id="' + bus.id + '" onclick="openBusFormById(' + bus.id + ')">' +
                    '<div class="bus-card-header">' +
                        '<span class="bus-card-plate">' + sanitizeInput(bus.plate) + '</span>' +
                        '<span class="bus-card-badge ' + status.class + '">' + (bus.spot ? 'موقف ' + bus.spot : 'انتظار موقف') + '</span>' +
                    '</div>' +
                    '<div class="bus-card-info">' +
                        '<span>B: ' + sanitizeInput(bus.busNo || '-') + '</span>' +
                        '<span>F: ' + sanitizeInput(bus.flight || '-') + '</span>' +
                        '<span>P: ' + sanitizeInput(bus.pax || '-') + '</span>' +
                        '<span>G: ' + sanitizeInput(bus.gate || '-') + '</span>' +
                    '</div>' +
                    '<div class="bus-card-progress">' +
                        '<div class="bus-card-progress-fill" style="width:' + (formsCompleted * 25) + '%"></div>' +
                    '</div>' +
                '</div>';
            });
            list.innerHTML = html;
        }
        
        // ✅ إصلاح #23: دالة آمنة لفتح نموذج الحافلة بواسطة ID
        function openBusFormById(busId) {
            var bus = busData.find(function(b) { return b.id === busId; });
            if (!bus) {
                showNotification('error', 'خطأ', 'الحافلة غير موجودة');
                return;
            }
            
            currentBusForForm = bus;
            
            if (!bus.spot) {
                openFormModal('ScrWelcomeLounge', bus);
            } else if (!bus.forms || !bus.forms.ScrSegregationExit) {
                openFormModal('ScrSegregationExit', bus);
            } else {
                openFormModal('ScrCurbside', bus);
            }
        }
        
        // الدالة القديمة للتوافق مع الكود القديم
        function openBusForm(busJson) {
            try {
                // ✅ إصلاح #24: استخدام safeJSONParse
                var bus = safeJSONParse(busJson.replace(/&quot;/g, '"'), null);
                if (!bus) {
                    showNotification('error', 'خطأ', 'بيانات الحافلة غير صالحة');
                    return;
                }
                openBusFormById(bus.id);
            } catch (error) {
                console.error('خطأ في فتح نموذج الحافلة:', error);
                showNotification('error', 'خطأ', 'فشل في فتح النموذج');
            }
        }

        function updateSegregationList() {
            var list = safeGetElement('segregationList');
            if (!list) return;
            
            var segregationBuses = busData.filter(function(b) { return b.spot; });
            safeSetText('segregationCount', segregationBuses.length);
            
            if (segregationBuses.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">لا توجد حافلات في الفرز</div>';
                return;
            }
            
            var html = '';
            segregationBuses.forEach(function(bus) {
                var status = getStatus(bus.arrival, bus.departure);
                html += '<div class="bus-card ' + status.class + '" onclick="showFormsMenu(event, ' + bus.spot + ')">' +
                    '<div class="bus-card-header">' +
                        '<span class="bus-card-plate">' + sanitizeInput(bus.plate) + '</span>' +
                        '<span class="bus-card-badge ' + status.class + '">موقف ' + bus.spot + '</span>' +
                    '</div>' +
                    '<div class="bus-card-info">' +
                        '<span>' + sanitizeInput(bus.flight) + '</span>' +
                        '<span>' + sanitizeInput(bus.pax || '-') + '</span>' +
                        '<span>' + status.hours.toFixed(1) + ' س</span>' +
                    '</div>' +
                '</div>';
            });
            list.innerHTML = html;
        }

        function updateDepartedList() {
            var list = safeGetElement('departedList');
            if (!list) return;
            
            safeSetText('departedCount', departedBuses.length);
            safeSetText('departedToday', departedBuses.length);
            
            var totalPax = departedBuses.reduce(function(s, b) { return s + (b.pax || 0); }, 0);
            safeSetText('departedPax', totalPax);
            
            if (departedBuses.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;">لا توجد حافلات غادرت</div>';
                return;
            }
            
            var html = '';
            departedBuses.slice(0, 20).forEach(function(bus) {
                html += '<div class="bus-card completed">' +
                    '<div class="bus-card-header">' +
                        '<span class="bus-card-plate">' + sanitizeInput(bus.plate) + '</span>' +
                        '<span class="bus-card-badge completed">مكتملة</span>' +
                    '</div>' +
                    '<div class="bus-card-info">' +
                        '<span>' + sanitizeInput(bus.flight) + '</span>' +
                        '<span>' + sanitizeInput(bus.pax || '-') + '</span>' +
                        '<span>' + sanitizeInput(bus.gate || '-') + '</span>' +
                    '</div>' +
                '</div>';
            });
            list.innerHTML = html;
        }

        // ═══════════════ ملء الشاشة ═══════════════
        function toggleFullscreen() {
            try {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            } catch (error) {
                console.error('خطأ في تبديل ملء الشاشة:', error);
            }
        }

        // ═══════════════ التكبير ═══════════════
        function zoomIn() { setZoom(Math.min(zoomLevel + 10, 150)); }
        function zoomOut() { setZoom(Math.max(zoomLevel - 10, 50)); }
        function zoomReset() { setZoom(100); }

        function setZoom(level) {
            zoomLevel = parseInt(level, 10);
            safeSetText('zoomLevel', zoomLevel + '%');
            var slider = safeGetElement('zoomSlider');
            if (slider) slider.value = zoomLevel;
            var contentArea = document.querySelector('.content-area');
            if (contentArea) {
                contentArea.style.transform = 'scale(' + (zoomLevel/100) + ')';
                contentArea.style.transformOrigin = 'top center';
            }
        }

        // ═══════════════ وضع التحرير ═══════════════
        function toggleEditMode() {
            editMode = !editMode;
            safeSetText('editBtn', editMode ? 'إيقاف التحرير' : 'تفعيل وضع التحرير');
            showNotification(editMode ? 'success' : 'info', 'وضع التحرير', editMode ? 'تم التفعيل' : 'تم الإيقاف');
        }

        // ═══════════════ التصدير والاستيراد ═══════════════
        function exportJSON() {
            try {
                var exportData = {
                    busData: busData,
                    dailyStats: {
                        buses: dailyStats.buses,
                        pax: dailyStats.pax,
                        early: dailyStats.early,
                        ontime: dailyStats.ontime,
                        late: dailyStats.late,
                        flights: Array.from(dailyStats.flights)
                    }
                };
                // ✅ إصلاح #25: استخدام safeJSONStringify
                var data = safeJSONStringify(exportData, '{}');
                if (data === '{}' && busData.length > 0) {
                    showNotification('error', 'خطأ', 'فشل في تصدير البيانات');
                    return;
                }
                downloadFile(data, 'LOCC_Data.json', 'application/json');
                showNotification('success', 'تصدير', 'تم تصدير البيانات بنجاح');
            } catch (error) {
                console.error('خطأ في تصدير JSON:', error);
                showNotification('error', 'خطأ', 'فشل في تصدير البيانات');
            }
        }

        function exportCSV() {
            try {
                var csv = 'الموقف,اللوحة,الرحلة,الركاب,البوابة,المغادرة,الحالة\n';
                busData.forEach(function(b) {
                    var s = getStatus(b.arrival, b.departure);
                    csv += b.spot + ',' + sanitizeInput(b.plate) + ',' + sanitizeInput(b.flight) + ',' + (b.pax || '') + ',' + (b.gate || '') + ',' + (b.departure || '') + ',' + s.label + '\n';
                });
                downloadFile(csv, 'LOCC_Data.csv', 'text/csv');
                showNotification('success', 'تصدير', 'تم تصدير CSV بنجاح');
            } catch (error) {
                console.error('خطأ في تصدير CSV:', error);
                showNotification('error', 'خطأ', 'فشل في تصدير CSV');
            }
        }

        function downloadFile(data, filename, type) {
            try {
                var blob = new Blob(['\ufeff' + data], { type: type + ';charset=utf-8' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(function() {
                    if (a.parentNode) document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (error) {
                console.error('خطأ في تحميل الملف:', error);
            }
        }

        function importJSON(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    // ✅ إصلاح #26: استخدام safeJSONParse مع التحقق
                    var d = safeJSONParse(ev.target.result, null);
                    if (!d) {
                        showNotification('error', 'خطأ', 'ملف JSON غير صالح');
                        return;
                    }
                    
                    // ✅ إصلاح #27: التحقق من بنية البيانات المستوردة
                    if (d.busData && Array.isArray(d.busData)) {
                        busData = d.busData;
                    } else if (Array.isArray(d)) {
                        busData = d;
                    } else {
                        showNotification('error', 'خطأ', 'بنية البيانات غير صحيحة');
                        return;
                    }
                    
                    if (d.dailyStats) {
                        dailyStats = {
                            buses: d.dailyStats.buses || 0,
                            pax: d.dailyStats.pax || 0,
                            early: d.dailyStats.early || 0,
                            ontime: d.dailyStats.ontime || 0,
                            late: d.dailyStats.late || 0,
                            flights: new Set(d.dailyStats.flights || [])
                        };
                    }
                    
                    updateStats();
                    renderParkingGrid('entranceGrid', 1, 42);
                    renderParkingGrid('exitGrid', 43, 87);
                    saveData();
                    showNotification('success', 'استيراد', 'تم استيراد البيانات بنجاح');
                } catch (error) {
                    console.error('خطأ في استيراد الملف:', error);
                    showNotification('error', 'خطأ', 'فشل استيراد الملف');
                }
            };
            reader.onerror = function() {
                showNotification('error', 'خطأ', 'فشل في قراءة الملف');
            };
            reader.readAsText(file);
        }

        function resetAll() {
            if (confirm('⚠️ هل أنت متأكد من حذف جميع البيانات؟')) {
                busData = [];
                dailyStats = { buses: 0, pax: 0, early: 0, ontime: 0, late: 0, flights: new Set() };
                localStorage.removeItem('LOCC_Data');
                updateStats();
                renderParkingGrid('entranceGrid', 1, 42);
                renderParkingGrid('exitGrid', 43, 87);
                showNotification('warning', 'مسح', 'تم حذف جميع البيانات');
            }
        }

        function clearAllData() {
            busData = [];
            departedBuses = [];
            dailyStats = { buses: 0, pax: 0, early: 0, ontime: 0, late: 0, flights: new Set() };
            
            updateStats();
            renderParkingGrid('entranceGrid', 1, 42);
            renderParkingGrid('exitGrid', 43, 87);
            renderGates();
            updateRegisteredList();
            updateSegregationList();
            updateDepartedList();
            updateKPIs();
            saveData();
            
            showNotification('success', 'تصفير', 'تم تصفير جميع البيانات والإحصائيات');
        }

        // ═══════════════ حفظ وتحميل البيانات ═══════════════
        // ✅ إصلاح #41: دالة بسيطة لحساب checksum
        function simpleChecksum(str) {
            var hash = 0;
            if (!str || str.length === 0) return hash.toString(16);
            for (var i = 0; i < str.length; i++) {
                var char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }
        
        // ✅ إصلاح #55: حفظ البيانات بتشفير آمن AES-GCM
        async function saveData() {
            try {
                var dataToSave = {
                    busData: busData,
                    departedBuses: departedBuses,
                    dailyStats: {
                        buses: dailyStats.buses,
                        pax: dailyStats.pax,
                        early: dailyStats.early,
                        ontime: dailyStats.ontime,
                        late: dailyStats.late,
                        flights: Array.from(dailyStats.flights)
                    }
                };
                // ✅ إصلاح #28: استخدام safeJSONStringify
                var jsonData = safeJSONStringify(dataToSave);
                // ✅ إصلاح #55: تشفير آمن AES-GCM مع Salt عشوائي
                var encryptedData = await secureEncrypt(jsonData);
                if (encryptedData) {
                    // ✅ إصلاح #41: إضافة checksum للتحقق من سلامة البيانات
                    var checksum = simpleChecksum(encryptedData);
                    localStorage.setItem('LOCC_Data', encryptedData);
                    localStorage.setItem('LOCC_Checksum', checksum);
                }
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
            }
        }

        // ✅ إصلاح #55: تحميل البيانات مع فك التشفير الآمن
        async function loadData() {
            try {
                var saved = localStorage.getItem('LOCC_Data');
                var savedChecksum = localStorage.getItem('LOCC_Checksum');

                // ✅ إصلاح #41: التحقق من checksum
                if (saved && savedChecksum) {
                    var calculatedChecksum = simpleChecksum(saved);
                    if (calculatedChecksum !== savedChecksum) {
                        console.warn('تحذير: تم اكتشاف تغيير في البيانات المحفوظة');
                        showNotification('warning', 'تحذير', 'تم اكتشاف تغيير غير متوقع في البيانات');
                    }
                }

                // ✅ إصلاح #55: فك التشفير الآمن (يدعم V2 + القديم)
                var decryptedData = '';
                if (saved) {
                    decryptedData = await secureDecrypt(saved);
                    // إذا فشل فك التشفير، جرب البيانات الخام (للتوافق مع البيانات القديمة)
                    if (!decryptedData || decryptedData.charAt(0) !== '{') {
                        decryptedData = saved;
                    }
                }

                // ✅ إصلاح #29: استخدام safeJSONParse
                var d = safeJSONParse(decryptedData, null);
                if (d) {
                    busData = d.busData || [];
                    departedBuses = d.departedBuses || [];
                    if (d.dailyStats) {
                        dailyStats = {
                            buses: d.dailyStats.buses || 0,
                            pax: d.dailyStats.pax || 0,
                            early: d.dailyStats.early || 0,
                            ontime: d.dailyStats.ontime || 0,
                            late: d.dailyStats.late || 0,
                            flights: new Set(d.dailyStats.flights || [])
                        };
                    }
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                busData = [];
                departedBuses = [];
                dailyStats = { buses: 0, pax: 0, early: 0, ontime: 0, late: 0, flights: new Set() };
            }
        }

        // ✅ إصلاح #31: تفعيل دالة الفلترة الفعلية
        var currentFilter = 'all';
        
        function filterBuses(type) {
            currentFilter = type;
            
            // الحصول على جميع المواقف
            var allSpots = document.querySelectorAll('.parking-spot');
            
            allSpots.forEach(function(spot) {
                var spotNum = parseInt(spot.dataset.spot, 10);
                var bus = busData.find(function(b) { return b.spot === spotNum; });
                
                if (type === 'all') {
                    // عرض الكل
                    spot.style.display = '';
                    spot.style.opacity = '1';
                } else if (!bus) {
                    // إخفاء المواقف الفارغة عند الفلترة
                    if (type === 'empty') {
                        spot.style.display = '';
                        spot.style.opacity = '1';
                    } else {
                        spot.style.opacity = '0.2';
                    }
                } else {
                    // فلترة حسب الحالة
                    var status = getStatus(bus.arrival, bus.departure);
                    if (status.class === type) {
                        spot.style.display = '';
                        spot.style.opacity = '1';
                        spot.style.transform = 'scale(1.05)';
                    } else {
                        spot.style.opacity = '0.2';
                        spot.style.transform = 'scale(1)';
                    }
                }
            });
            
            // تحديث قوائم الحافلات حسب الفلتر
            filterBusLists(type);
            
            // تحديث مظهر أزرار الفلترة
            updateFilterButtons(type);
            
            showNotification('info', 'فلترة', 'عرض: ' + (type === 'all' ? 'الكل' : type === 'early' ? 'المبكر' : type === 'ontime' ? 'في الموعد' : type === 'late' ? 'المتأخر' : type));
        }
        
        function filterBusLists(type) {
            // فلترة قائمة الحافلات المسجلة
            var registeredCards = document.querySelectorAll('#registeredList .bus-card');
            registeredCards.forEach(function(card) {
                if (type === 'all') {
                    card.style.display = '';
                } else if (card.classList.contains(type)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // فلترة قائمة حافلات الفرز
            var segregationCards = document.querySelectorAll('#segregationList .bus-card');
            segregationCards.forEach(function(card) {
                if (type === 'all') {
                    card.style.display = '';
                } else if (card.classList.contains(type)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function updateFilterButtons(activeType) {
            // إزالة التحديد من جميع الأزرار
            var filterButtons = document.querySelectorAll('.stats-group .mini-stat');
            filterButtons.forEach(function(btn, index) {
                // أول 4 أزرار فقط هي أزرار الفلترة
                if (index < 4) {
                    btn.style.boxShadow = '';
                    btn.style.transform = '';
                }
            });
            
            // تحديد الزر النشط
            var activeIndex = { 'all': 0, 'early': 1, 'ontime': 2, 'late': 3 };
            if (activeIndex[activeType] !== undefined) {
                var activeBtn = filterButtons[activeIndex[activeType]];
                if (activeBtn) {
                    activeBtn.style.boxShadow = '0 0 15px var(--primary)';
                    activeBtn.style.transform = 'scale(1.1)';
                }
            }
        }
        
        // دالة لإعادة تعيين الفلتر
        function resetFilter() {
            filterBuses('all');
        }

        // ═══════════════ حجم المواقف ═══════════════
        var spotSize = 55;

        function spotSizeIn() { setSpotSize(Math.min(spotSize + 5, 100)); }
        function spotSizeOut() { setSpotSize(Math.max(spotSize - 5, 40)); }

        function setSpotSize(size) {
            spotSize = parseInt(size, 10);
            safeSetText('spotSizeLevel', spotSize + 'px');
            var slider = safeGetElement('spotSizeSlider');
            if (slider) slider.value = spotSize;
            document.querySelectorAll('.parking-spot').forEach(function(spot) {
                spot.style.minHeight = spotSize + 'px';
                spot.style.maxWidth = spotSize + 'px';
            });
        }

        // ═══════════════ بدء النظام ═══════════════
        // ✅ إصلاح #30: استخدام DOMContentLoaded بدلاً من التنفيذ المباشر
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // ✅ إصلاح #34: تصدير الدوال المطلوبة للـ onclick handlers
        window.togglePanel = togglePanel;
        window.toggleFullscreen = toggleFullscreen;
        window.filterBuses = filterBuses;
        window.showTab = showTab;
        window.zoomOut = zoomOut;
        window.zoomReset = zoomReset;
        window.zoomIn = zoomIn;
        window.setZoom = setZoom;
        window.spotSizeOut = spotSizeOut;
        window.spotSizeIn = spotSizeIn;
        window.setSpotSize = setSpotSize;
        window.toggleEditMode = toggleEditMode;
        window.addNewBus = addNewBus;
        window.editSpot = editSpot;
        window.moveSpot = moveSpot;
        window.deleteSpot = deleteSpot;
        window.exportJSON = exportJSON;
        window.exportCSV = exportCSV;
        window.importJSON = importJSON;
        window.resetAll = resetAll;
        window.clearAllData = clearAllData;
        window.loadTestData = loadTestData;
        window.updateThresholds = updateThresholds;
        window.updateColors = updateColors;
        window.toggleSetting = toggleSetting;
        window.updateSpotSize = updateSpotSize;
        window.saveSettings = saveSettings;
        window.loadSettings = loadSettings;
        window.resetSettings = resetSettings;
        window.clearAlerts = clearAlerts;
        window.testAlert = testAlert;
        window.openForm = openForm;
        window.showFormsMenu = showFormsMenu;
        window.selectFormFromMenu = selectFormFromMenu;
        window.closeModal = closeModal;
        window.closeModalOnOverlay = closeModalOnOverlay;
        window.saveFormData = saveFormData;
        window.openBusFormById = openBusFormById;
        window.openBusForm = openBusForm;
        window.resetFilter = resetFilter;
        window.confirmMoveSpot = confirmMoveSpot;
        window.selectSpot = selectSpot;
        
        })(window, document);
    </script>
</body>
</html>
